<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask + åŠ å¯†è²¨å¹£ æ¸¬è©¦äº¤æ˜“</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .network-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }
        
        .faucet-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        }
        
        .transaction-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
        }
        
        .info-card {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc1 100%);
            grid-column: 1 / -1;
            margin-bottom: 30px;
        }
        
        .status-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
        }
        
        .status-value {
            font-family: monospace;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .btn-info:hover {
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            margin-bottom: 15px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .link-list {
            list-style: none;
            padding: 0;
        }
        
        .link-list li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .link-list li:before {
            content: "ğŸ”—";
            position: absolute;
            left: 0;
        }
        
        .link-list a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .link-list a:hover {
            text-decoration: underline;
        }
        
        .usage-list {
            list-style: none;
            padding: 0;
        }
        
        .usage-list li {
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
        }
        
        .usage-list li:before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            background: #4CAF50;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .usage-list {
            counter-reset: step-counter;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        #messageBox {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 1000;
        }

        .account-select {
            width: 75%;
            max-width: 280px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            background-color: rgba(255,255,255,0.8);
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s ease;
            height: 28px;
        }

        .account-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .account-select:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦Š MetaMask åŠ å¯†è²¨å¹£æ¸¬è©¦å¹³å°</h1>
            <p>å®‰å…¨ä¾¿æ·çš„å€å¡Šéˆæ¸¬è©¦äº¤æ˜“ç’°å¢ƒ</p>
        </div>
        
        <div class="main-content">
            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="card info-card">
                <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜</h3>
                <ol class="usage-list">
                <li>ç¢ºä¿å®‰è£äº† MetaMask ç€è¦½å™¨æ“´å±•</li>
                <li>é»æ“Šã€Œé€£æ¥ MetaMaskã€æŒ‰éˆ•</li>
                <li><strong>æ–°æ‰‹æ¨è–¦ï¼šå…ˆä½¿ç”¨æ¸¬è©¦ç¶²ç²å–å…è²»ä»£å¹£</strong></li>
                <li>æ·»åŠ ç›¸æ‡‰çš„ç¶²çµ¡é…ç½®</li>
                <li>è¼¸å…¥æ¥æ”¶åœ°å€å’Œé‡‘é¡ï¼ŒåŸ·è¡Œæ¸¬è©¦äº¤æ˜“</li>
            </ol>
                <p style="margin-top: 15px;"><strong>ğŸ”— æ›´å¤š Chain ID è³‡è¨Šï¼š</strong><a href="https://chainlist.org/" target="_blank">Chainlist.org</a> - å®Œæ•´çš„ EVM ç¶²çµ¡æ¸…å–®ï¼Œå¹«åŠ©æ‚¨é€£æ¥åˆ°æ­£ç¢ºçš„ Chain ID å’Œ Network ID</p>
        </div>

            <div class="grid">
                <!-- é€£æ¥ç‹€æ…‹ -->
                <div class="card status-card">
                    <h3>ğŸ”— é€£æ¥ç‹€æ…‹</h3>
                    <div class="status-info">
                        <div class="status-item">
                            <span class="status-label">é€£æ¥ç‹€æ…‹</span>
                            <span class="status-value" id="connectionStatus">æœªé€£æ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç•¶å‰å¸³æˆ¶</span>
                            <select id="accountSelect" class="account-select" onchange="switchAccount()" disabled>
                                <option value="">è«‹å…ˆé€£æ¥éŒ¢åŒ…</option>
                            </select>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç¶²çµ¡</span>
                            <span class="status-value" id="networkInfo">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Chain ID</span>
                            <span class="status-value" id="chainIdInfo">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">é¤˜é¡</span>
                            <span class="status-value" id="balanceInfo">--</span>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="connectBtn" class="btn-primary" onclick="connectMetaMask()">
                            ğŸ”Œ é€£æ¥ MetaMask
                        </button>
                        <button id="refreshAccountsBtn" class="btn-secondary" onclick="refreshAccounts()" disabled>
                            ğŸ”„ åˆ·æ–°å¸³æˆ¶
                        </button>
                    </div>
        </div>

                <!-- ç¶²çµ¡ç®¡ç† -->
                <div class="card network-card">
                    <h3>ğŸŒ ç¶²çµ¡ç®¡ç†</h3>
                    <p style="margin-bottom: 15px; font-size: 0.9em; color: #666;">é¸æ“‡ä¸¦åˆ‡æ›åˆ°æ‚¨éœ€è¦çš„æ¸¬è©¦ç¶²çµ¡</p>
                    <div class="button-group">
                        <button id="addSepoliaBtn" class="btn-secondary" onclick="addSepoliaTestnet()" disabled>
                            âš¡ æ·»åŠ åŠåˆ‡æ› Ethereum Sepolia
                        </button>
                        <button id="addPolygonBtn" class="btn-secondary" onclick="addPolygonAmoyTestnet()" disabled>
                            ğŸ”· æ·»åŠ åŠåˆ‡æ› Polygon Amoy
                        </button>
                        <button id="openChainlistBtn" class="btn-info" onclick="openChainlist()">
                            ğŸ”— æŸ¥çœ‹æ›´å¤šç¶²çµ¡
                        </button>
                    </div>
                </div>
                
                <!-- å…è²»ä»£å¹£ -->
                <div class="card faucet-card">
                    <h3>ğŸ†“ å…è²»æ¸¬è©¦ä»£å¹£</h3>
                    <p style="margin-bottom: 15px; font-size: 0.9em; color: #666;">å¾å®˜æ–¹æ°´é¾é ­ç²å–å…è²»æ¸¬è©¦ä»£å¹£</p>
                    <ul class="link-list">
                        <li><a href="https://cloud.google.com/application/web3/faucet/ethereum/sepolia" target="_blank">Google Ethereum Sepolia æ°´é¾é ­</a></li>
                        <li><a href="https://faucet.polygon.technology/" target="_blank">Polygon å®˜æ–¹æ°´é¾é ­</a></li>
                    </ul>
                    <div class="button-group">
                        <button id="openFaucetBtn" class="btn-success" onclick="openFaucet()" disabled>
                            ğŸ’§ å¿«é€Ÿæ‰“é–‹æ°´é¾é ­
                        </button>
                    </div>
        </div>

                <!-- æ¸¬è©¦äº¤æ˜“ -->
                <div class="card transaction-card">
                    <h3>ğŸ’¸ æ¸¬è©¦äº¤æ˜“</h3>
                    <div class="form-group">
                        <label class="form-label" for="recipientAddress">æ¥æ”¶åœ°å€</label>
                <input type="text" id="recipientAddress" placeholder="0x..." />
            </div>
                    <div class="form-group">
                        <label class="form-label" for="amount">é‡‘é¡</label>
                <input type="text" id="amount" placeholder="0.001" />
                    </div>
                    <div class="button-group">
                        <button id="sendBtn" class="btn-primary" onclick="sendTransaction()" disabled>
                            ğŸš€ ç™¼é€æ¸¬è©¦äº¤æ˜“
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="messageBox"></div>
    <script>
        // ç¶²çµ¡é…ç½®
        // Ethereum Sepolia æ¸¬è©¦ç¶²é…ç½®
        const SEPOLIA_TESTNET = {
            chainId: '0xaa36a7', // 11155111 in hex
            chainName: 'Sepolia Test Network',
            nativeCurrency: {
                name: 'ETH',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.infura.io'],
            blockExplorerUrls: ['https://sepolia.etherscan.io']
        };

        // Polygon Amoy æ¸¬è©¦ç¶²é…ç½®
        const POLYGON_AMOY_TESTNET = {
            chainId: '0x13882', // 80002 in hex
            chainName: 'Polygon Amoy Testnet',
            nativeCurrency: {
                name: 'POL',
                symbol: 'POL',
                decimals: 18
            },
            rpcUrls: ['https://rpc-amoy.polygon.technology'],
            blockExplorerUrls: ['https://amoy.polygonscan.com']
        };

        // å…¨å±€è®Šé‡
        let currentAccount = null;
        let allAccounts = [];
        let web3 = null;

        // æª¢æŸ¥ MetaMask æ˜¯å¦å®‰è£
        function checkMetaMaskInstallation() {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask å·²å®‰è£ï¼');
                return true;
            } else {
                showMessage('è«‹å…ˆå®‰è£ MetaMask ç€è¦½å™¨æ“´å±•ï¼', 'error');
                return false;
            }
        }

        // é€£æ¥ MetaMask
        async function connectMetaMask() {
            if (!checkMetaMaskInstallation()) {
                return;
            }

            try {
                // è«‹æ±‚é€£æ¥å¸³æˆ¶
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length > 0) {
                    allAccounts = accounts;
                    currentAccount = accounts[0];
                    updateConnectionStatus();
                    await updateAccountInfo();
                    
                    // æ›´æ–°å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰æ¡†
                    updateAccountSelect();
                    
                    // å•Ÿç”¨æŒ‰éˆ•
                    document.getElementById('addSepoliaBtn').disabled = false;
                    document.getElementById('addPolygonBtn').disabled = false;
                    document.getElementById('openFaucetBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('refreshAccountsBtn').disabled = false;
                    document.getElementById('accountSelect').disabled = false;
                    
                    showMessage('MetaMask é€£æ¥æˆåŠŸï¼', 'success');
                }
            } catch (error) {
                console.error('é€£æ¥å¤±æ•—:', error);
                showMessage(`é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰æ¡†
        function updateAccountSelect() {
            const accountSelect = document.getElementById('accountSelect');
            accountSelect.innerHTML = '';
            
            if (allAccounts.length === 0) {
                accountSelect.innerHTML = '<option value="">è«‹å…ˆé€£æ¥éŒ¢åŒ…</option>';
                return;
            }
            
            allAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = `${account.slice(0, 10)}...${account.slice(-6)}`;
                if (account === currentAccount) {
                    option.selected = true;
                }
                accountSelect.appendChild(option);
            });
        }

        // æ·»åŠ  Sepolia æ¸¬è©¦ç¶²
        async function addSepoliaTestnet() {
            await addNetwork(SEPOLIA_TESTNET, 'Ethereum Sepolia æ¸¬è©¦ç¶²');
        }

        // æ·»åŠ  Polygon Amoy æ¸¬è©¦ç¶²
        async function addPolygonAmoyTestnet() {
            await addNetwork(POLYGON_AMOY_TESTNET, 'Polygon Amoy æ¸¬è©¦ç¶²');
        }

        // é€šç”¨æ·»åŠ ç¶²çµ¡å‡½æ•¸
        async function addNetwork(networkConfig, networkName) {
            if (!checkMetaMaskInstallation()) {
                return;
            }

            try {
                // å˜—è©¦åˆ‡æ›åˆ°æŒ‡å®šç¶²çµ¡
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: networkConfig.chainId }],
                });
                
                showMessage(`å·²åˆ‡æ›åˆ° ${networkName}ï¼`, 'success');
            } catch (switchError) {
                // å¦‚æœç¶²çµ¡ä¸å­˜åœ¨ï¼Œæ·»åŠ ç¶²çµ¡
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [networkConfig],
                        });
                        showMessage(`${networkName} æ·»åŠ æˆåŠŸï¼`, 'success');
                    } catch (addError) {
                        console.error('æ·»åŠ ç¶²çµ¡å¤±æ•—:', addError);
                        showMessage(`æ·»åŠ ç¶²çµ¡å¤±æ•—: ${addError.message}`, 'error');
                    }
                } else {
                    console.error('åˆ‡æ›ç¶²çµ¡å¤±æ•—:', switchError);
                    showMessage(`åˆ‡æ›ç¶²çµ¡å¤±æ•—: ${switchError.message}`, 'error');
                }
            }
            
            // æ›´æ–°ç¶²çµ¡ä¿¡æ¯
            setTimeout(updateAccountInfo, 1000);
        }

        // æ‰“é–‹æ°´é¾é ­é ˜å–å…è²»ä»£å¹£
        async function openFaucet() {
            if (!currentAccount) {
                showMessage('è«‹å…ˆé€£æ¥ MetaMaskï¼', 'error');
                return;
            }
            
            // ç²å–ç•¶å‰ç¶²çµ¡
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            let faucetUrl = 'https://cloud.google.com/application/web3/faucet/ethereum/sepolia';
            let networkName = 'æ°´é¾é ­';
            
            // æ ¹æ“šç¶²çµ¡é¸æ“‡å°æ‡‰çš„æ°´é¾é ­
            switch(chainId) {
                case '0xaa36a7': // Sepolia
                    faucetUrl = 'https://cloud.google.com/application/web3/faucet/ethereum/sepolia';
                    networkName = 'Google Ethereum Sepolia æ°´é¾é ­';
                    break;
                case '0x13882': // Polygon Amoy
                    faucetUrl = 'https://faucet.polygon.technology/';
                    networkName = 'Polygon å®˜æ–¹æ°´é¾é ­';
                    break;
                default:
                    faucetUrl = 'https://cloud.google.com/application/web3/faucet/ethereum/sepolia';
                    networkName = 'Google Ethereum Sepolia æ°´é¾é ­';
            }
            
            // è¤‡è£½åœ°å€åˆ°å‰ªè²¼æ¿
            navigator.clipboard.writeText(currentAccount).then(() => {
                showMessage(`âœ… å·²è¤‡è£½ä½ çš„éŒ¢åŒ…åœ°å€ï¼š${currentAccount.slice(0, 10)}...${currentAccount.slice(-6)}\nå³å°‡æ‰“é–‹ ${networkName} æ°´é¾é ­ç¶²ç«™ï¼Œè²¼ä¸Šåœ°å€å³å¯é ˜å–å…è²»æ¸¬è©¦å¹£ï¼`, 'success');
                
                // æ‰“é–‹æ°´é¾é ­ç¶²ç«™
                setTimeout(() => {
                    window.open(faucetUrl, '_blank');
                }, 2000);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                showMessage(`ä½ çš„éŒ¢åŒ…åœ°å€ï¼š${currentAccount.slice(0, 10)}...${currentAccount.slice(-6)}\nè«‹æ‰‹å‹•è¤‡è£½åˆ°æ°´é¾é ­ç¶²ç«™é ˜å–å…è²»ä»£å¹£`, 'info');
                window.open(faucetUrl, '_blank');
            });
        }

        // æ‰“é–‹ Chainlist æŸ¥çœ‹æ›´å¤šç¶²çµ¡
        function openChainlist() {
            showMessage('å³å°‡æ‰“é–‹ Chainlist.org ç¶²ç«™ï¼Œæ‚¨å¯ä»¥åœ¨é‚£è£¡æ‰¾åˆ°æ‰€æœ‰ EVM ç¶²çµ¡çš„ Chain ID å’Œ RPC è¨­å®šï¼', 'info');
            
            // æ‰“é–‹ Chainlist ç¶²ç«™
            setTimeout(() => {
                window.open('https://chainlist.org/', '_blank');
            }, 1500);
        }

        // ç™¼é€æ¸¬è©¦äº¤æ˜“
        async function sendTransaction() {
            const recipientAddress = document.getElementById('recipientAddress').value;
            const amount = document.getElementById('amount').value;

            // é©—è­‰è¼¸å…¥
            if (!recipientAddress || !amount) {
                showMessage('è«‹å¡«å¯«æ¥æ”¶åœ°å€å’Œé‡‘é¡ï¼', 'error');
                return;
            }

            if (!recipientAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                showMessage('æ¥æ”¶åœ°å€æ ¼å¼ä¸æ­£ç¢ºï¼', 'error');
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                showMessage('é‡‘é¡å¿…é ˆæ˜¯æ­£æ•¸ï¼', 'error');
                return;
            }

            try {
                // è½‰æ›é‡‘é¡ç‚º Wei (1 ETH/POL = 10^18 Wei)
                const amountInWei = (parseFloat(amount) * Math.pow(10, 18)).toString(16);

                // æ§‹å»ºäº¤æ˜“åƒæ•¸
                const transactionParameters = {
                    to: recipientAddress,
                    from: currentAccount,
                    value: '0x' + amountInWei,
                    gas: '0x5208', // 21000 gas (æ¨™æº–è½‰å¸³)
                };

                // ç™¼é€äº¤æ˜“
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters],
                });

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const explorerUrl = getExplorerUrl(chainId);
                
                showMessage(`äº¤æ˜“å·²ç™¼é€ï¼\näº¤æ˜“å“ˆå¸Œ: ${txHash}\nå¯åœ¨ ${explorerUrl} æŸ¥çœ‹äº¤æ˜“ç‹€æ…‹ã€‚`, 'success');
                
                // æ›´æ–°é¤˜é¡
                setTimeout(updateAccountInfo, 3000);
                
            } catch (error) {
                console.error('äº¤æ˜“å¤±æ•—:', error);
                showMessage(`äº¤æ˜“å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (currentAccount) {
                statusElement.textContent = 'âœ… å·²é€£æ¥';
                statusElement.style.color = 'green';
            } else {
                statusElement.textContent = 'âŒ æœªé€£æ¥';
                statusElement.style.color = 'red';
            }
        }

        // æ›´æ–°å¸³æˆ¶ä¿¡æ¯
        async function updateAccountInfo() {
            if (!currentAccount) return;

            try {
                // ç²å–ç•¶å‰ç¶²çµ¡
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);
                document.getElementById('networkInfo').textContent = `${networkName}`;
                
                // é¡¯ç¤ºChain IDï¼ˆåå…­é€²åˆ¶å’Œåé€²åˆ¶ï¼‰
                const chainIdDecimal = parseInt(chainId, 16);
                document.getElementById('chainIdInfo').textContent = `${chainIdDecimal} (${chainId})`;

                // ç²å–é¤˜é¡
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [currentAccount, 'latest']
                });
                
                const balanceInEther = parseInt(balance, 16) / Math.pow(10, 18);
                document.getElementById('balanceInfo').textContent = 
                    `${balanceInEther.toFixed(6)} ${getNetworkCurrency(chainId)}`;

            } catch (error) {
                console.error('ç²å–å¸³æˆ¶ä¿¡æ¯å¤±æ•—:', error);
            }
        }

        // ç²å–ç¶²çµ¡åç¨±
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum ä¸»ç¶²',
                '0xaa36a7': 'Ethereum Sepolia æ¸¬è©¦ç¶²',
                '0x13882': 'Polygon Amoy æ¸¬è©¦ç¶²'
            };
            return networks[chainId] || `æœªçŸ¥ç¶²çµ¡ (${chainId})`;
        }

        // ç²å–ç¶²çµ¡è²¨å¹£
        function getNetworkCurrency(chainId) {
            const currencies = {
                '0x1': 'ETH',
                '0xaa36a7': 'ETH',
                '0x13882': 'POL'
            };
            return currencies[chainId] || 'ETH';
        }

        // ç²å–å€å¡Šç€è¦½å™¨URL
        function getExplorerUrl(chainId) {
            const explorers = {
                '0x1': 'Etherscan',
                '0xaa36a7': 'Sepolia Etherscan',
                '0x13882': 'Amoy Polygonscan'
            };
            return explorers[chainId] || 'å€å¡Šç€è¦½å™¨';
        }

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            
            // æ ¹æ“šé¡å‹è¨­ç½®å°æ‡‰çš„CSSé¡
            let alertClass = 'alert-info';
            switch(type) {
                case 'success':
                    alertClass = 'alert-success';
                    break;
                case 'error':
                    alertClass = 'alert-error';
                    break;
                case 'info':
                default:
                    alertClass = 'alert-info';
                    break;
            }
            
            messageBox.innerHTML = `<div class="alert ${alertClass}">${message.replace(/\n/g, '<br>')}</div>`;
            
            // è‡ªå‹•æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageBox.innerHTML = '';
            }, 8000);
        }

        // ç›£è½å¸³æˆ¶è®Šæ›´
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // æ²’æœ‰å¸³æˆ¶ï¼Œæ¸…ç©ºæ‰€æœ‰ç‹€æ…‹
                    allAccounts = [];
                    currentAccount = null;
                    updateConnectionStatus();
                    document.getElementById('networkInfo').textContent = '--';
                    document.getElementById('chainIdInfo').textContent = '--';
                    document.getElementById('balanceInfo').textContent = '--';
                    document.getElementById('accountSelect').innerHTML = '<option value="">è«‹å…ˆé€£æ¥éŒ¢åŒ…</option>';
                    document.getElementById('accountSelect').disabled = true;
                    
                    // ç¦ç”¨æŒ‰éˆ•
                    document.getElementById('addSepoliaBtn').disabled = true;
                    document.getElementById('addPolygonBtn').disabled = true;
                    document.getElementById('openFaucetBtn').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    document.getElementById('refreshAccountsBtn').disabled = true;
                    
                    showMessage('MetaMask å·²æ–·é–‹é€£æ¥', 'error');
                } else {
                    // æœ‰å¸³æˆ¶ï¼Œæ›´æ–°å¸³æˆ¶åˆ—è¡¨
                    allAccounts = accounts;
                    
                    // å¦‚æœç•¶å‰å¸³æˆ¶ä¸åœ¨æ–°åˆ—è¡¨ä¸­ï¼Œé¸æ“‡ç¬¬ä¸€å€‹å¸³æˆ¶
                    if (!accounts.includes(currentAccount)) {
                        currentAccount = accounts[0];
                    }
                    
                    // æ›´æ–°ç•Œé¢
                    updateConnectionStatus();
                    updateAccountInfo();
                    updateAccountSelect();
                    
                    // å•Ÿç”¨æŒ‰éˆ•
                    document.getElementById('addSepoliaBtn').disabled = false;
                    document.getElementById('addPolygonBtn').disabled = false;
                    document.getElementById('openFaucetBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('refreshAccountsBtn').disabled = false;
                    document.getElementById('accountSelect').disabled = false;
                    
                    showMessage('å¸³æˆ¶å·²æ›´æ–°', 'info');
                }
            });

            // ç›£è½ç¶²çµ¡è®Šæ›´
            window.ethereum.on('chainChanged', function (chainId) {
                updateAccountInfo();
                showMessage(`å·²åˆ‡æ›åˆ° ${getNetworkName(chainId)} ç¶²çµ¡`, 'info');
            });
        }

        // åˆ‡æ›å¸³æˆ¶
        async function switchAccount() {
            const selectedAccount = document.getElementById('accountSelect').value;
            
            if (!selectedAccount || selectedAccount === '') {
                showMessage('è«‹é¸æ“‡ä¸€å€‹å¸³æˆ¶ï¼', 'error');
                return;
            }

            if (selectedAccount === currentAccount) {
                showMessage('æ‚¨å·²ç¶“åœ¨ä½¿ç”¨æ­¤å¸³æˆ¶ï¼', 'info');
                return;
            }

            try {
                // æ›´æ–°ç•¶å‰å¸³æˆ¶
                currentAccount = selectedAccount;
                
                // æ›´æ–°ç•Œé¢é¡¯ç¤º
                updateConnectionStatus();
                await updateAccountInfo();
                
                showMessage(`å·²åˆ‡æ›åˆ°å¸³æˆ¶ï¼š${selectedAccount.slice(0, 10)}...${selectedAccount.slice(-6)}`, 'success');
            } catch (error) {
                console.error('åˆ‡æ›å¸³æˆ¶å¤±æ•—:', error);
                showMessage(`åˆ‡æ›å¸³æˆ¶å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°å¸³æˆ¶åˆ—è¡¨
        async function refreshAccounts() {
            if (!checkMetaMaskInstallation()) {
                return;
            }
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length > 0) {
                    allAccounts = accounts;
                    
                    // å¦‚æœç•¶å‰å¸³æˆ¶ä¸åœ¨æ–°çš„å¸³æˆ¶åˆ—è¡¨ä¸­ï¼Œé¸æ“‡ç¬¬ä¸€å€‹å¸³æˆ¶
                    if (!accounts.includes(currentAccount)) {
                        currentAccount = accounts[0];
                    }
                    
                    // æ›´æ–°å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰æ¡†
                    updateAccountSelect();
                    
                    // æ›´æ–°ç•Œé¢é¡¯ç¤º
                    updateConnectionStatus();
                    await updateAccountInfo();
                    
                    // å•Ÿç”¨ç›¸é—œæŒ‰éˆ•
                    document.getElementById('addSepoliaBtn').disabled = false;
                    document.getElementById('addPolygonBtn').disabled = false;
                    document.getElementById('openFaucetBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('refreshAccountsBtn').disabled = false;
                    document.getElementById('accountSelect').disabled = false;
                    
                    showMessage(`å·²åˆ·æ–°å¸³æˆ¶åˆ—è¡¨ï¼Œå…±æ‰¾åˆ° ${accounts.length} å€‹å¸³æˆ¶`, 'success');
                } else {
                    // æ²’æœ‰å¸³æˆ¶ï¼Œæ¸…ç©ºç‹€æ…‹
                    allAccounts = [];
                    currentAccount = null;
                    updateConnectionStatus();
                    document.getElementById('networkInfo').textContent = '--';
                    document.getElementById('chainIdInfo').textContent = '--';
                    document.getElementById('balanceInfo').textContent = '--';
                    document.getElementById('accountSelect').innerHTML = '<option value="">è«‹å…ˆé€£æ¥éŒ¢åŒ…</option>';
                    document.getElementById('accountSelect').disabled = true;
                    
                    showMessage('æœªæ‰¾åˆ°å·²é€£æ¥çš„å¸³æˆ¶ï¼Œè«‹é‡æ–°é€£æ¥MetaMask', 'error');
                }
            } catch (error) {
                console.error('åˆ·æ–°å¸³æˆ¶å¤±æ•—:', error);
                showMessage(`åˆ·æ–°å¸³æˆ¶å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.addEventListener('load', async () => {
            // æª¢æŸ¥æ˜¯å¦å·²é€£æ¥
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        allAccounts = accounts; // åˆå§‹åŒ– allAccounts
                        currentAccount = accounts[0];
                        updateConnectionStatus();
                        await updateAccountInfo();
                        
                        // æ›´æ–°å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰æ¡†
                        updateAccountSelect();
                        
                        // å•Ÿç”¨æŒ‰éˆ•
                        document.getElementById('addSepoliaBtn').disabled = false;
                        document.getElementById('addPolygonBtn').disabled = false;
                        document.getElementById('openFaucetBtn').disabled = false;
                        document.getElementById('sendBtn').disabled = false;
                        document.getElementById('refreshAccountsBtn').disabled = false; // å•Ÿç”¨åˆ·æ–°æŒ‰éˆ•
                        document.getElementById('accountSelect').disabled = false; // å•Ÿç”¨é¸æ“‡æ¡†
                    } else {
                        // ç¢ºä¿æœªé€£æ¥æ™‚é¡¯ç¤ºé è¨­å€¼
                        document.getElementById('networkInfo').textContent = '--';
                        document.getElementById('chainIdInfo').textContent = '--';
                        document.getElementById('balanceInfo').textContent = '--';
                        document.getElementById('accountSelect').innerHTML = '<option value="">è«‹å…ˆé€£æ¥éŒ¢åŒ…</option>'; // æ¸…ç©ºé¸æ“‡æ¡†
                        document.getElementById('accountSelect').disabled = true; // ç¦ç”¨é¸æ“‡æ¡†
                        document.getElementById('refreshAccountsBtn').disabled = true; // ç¦ç”¨åˆ·æ–°æŒ‰éˆ•
                    }
                } catch (error) {
                    console.error('æª¢æŸ¥é€£æ¥ç‹€æ…‹å¤±æ•—:', error);
                }
            }
        });
    </script>
</body>
</html> 