<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelé¢¨æ ¼QRç¢¼æ˜ å°„å™¨</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- QR Scanner -->
    <script type="module" src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js"></script>
    <!-- SheetJS for Excel support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ”åƒé ­å€åŸŸç¾åŒ– */
        .camera-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #dee2e6;
        }
        
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .camera-header h4 {
            margin: 0;
            color: #495057;
            font-weight: 600;
        }
        
        .camera-status {
            background: #d4edda;
            color: #155724;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #c3e6cb;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 0;
            border-radius: 12px 0 0 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        

        #result {
            font-size: 18px;
            margin-top: 20px;
            word-wrap: break-word;
        }
        
        /* Excelé¢¨æ ¼è¡¨æ ¼ */
        .excel-table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .excel-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .excel-table td {
            border: 1px solid #dee2e6;
            padding: 2px;
            min-width: 120px;
            position: relative;
        }
        
        .excel-table input {
            border: none;
            outline: none;
            width: 100%;
            padding: 8px 6px;
            background: transparent;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .excel-table input:focus {
            background: #e3f2fd;
            box-shadow: inset 0 0 0 2px #2196f3;
            border-radius: 2px;
        }
        
        .excel-table input:hover {
            background: #f8f9fa;
        }
        
        .excel-table .selected {
            background: #e3f2fd;
            box-shadow: inset 0 0 0 2px #2196f3;
        }
        
        .excel-table .selected input {
            background: #e3f2fd;
        }
        
        .excel-table .matched-row {
            background: #d4edda !important;
            animation: highlightRow 2s ease-in-out;
        }
        
        .excel-table .matched-row input {
            background: #d4edda;
            font-weight: bold;
        }
        
        .excel-table .duplicate-row {
            background: #fff3cd !important;
            animation: highlightDuplicate 1s ease-in-out;
        }
        
        .excel-table .duplicate-row input {
            background: #fff3cd;
            font-weight: bold;
        }
        
        @keyframes highlightRow {
            0% { background: #fff3cd; }
            50% { background: #d4edda; }
            100% { background: #d4edda; }
        }
        
        @keyframes highlightDuplicate {
            0% { background: #ffeaa7; }
            50% { background: #fff3cd; }
            100% { background: #fff3cd; }
        }
        
        .excel-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .excel-table tr:hover {
            background-color: #f0f8ff;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .toolbar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border: 2px solid #dee2e6;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar button {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .toolbar button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        .toolbar button.btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .toolbar button.btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-indicator.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-indicator.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 576px) {
            #video-container {
                max-width: 100%;
                border-radius: 12px 0 0 12px;
            }
            .parameter-display {
                border-radius: 0 12px 12px 0;
            }
            #result {
                font-size: 16px;
                padding: 10px;
            }
            .table-container {
                max-height: 350px;
            }
            h2 {
                font-size: 1.5rem;
            }
            .excel-table {
                font-size: 13px;
            }
            .excel-table input {
                font-size: 13px;
                padding: 6px 4px;
            }
            .toolbar {
                padding: 10px;
            }
            .toolbar button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        /* è¤‡è£½è²¼ä¸Šæç¤º */
        .paste-hint {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* èª¿è©¦ä¿¡æ¯å€åŸŸ */
        .debug-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }
        
        .debug-header h5 {
            margin: 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .debug-info {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        /* è¡¨æ ¼è¡Œè™Ÿ */
        .row-number {
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            font-size: 12px;
            min-width: 30px;
            max-width: 30px;
            width: 30px;
        }
        
        .scan-result-status {
            min-width: 120px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #dee2e6;
            background: #e2e3e5;
            color: #383d41;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .scan-result-status.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .scan-result-status.fail {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .scan-result-status.info {
            background: #e2e3e5;
            color: #383d41;
            border-color: #dee2e6;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        .table-header h5 {
            margin: 0;
            color: #495057;
            font-size: 18px;
            font-weight: 700;
        }
        .table-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .table-toolbar button {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .table-toolbar button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: #5a6268;
            border-color: #545b62;
        }
        .table-toolbar button.btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .table-toolbar button.btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .duplicate-warning {
            background: #fff3cd;
            color: #856404;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #ffeaa7;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: pulseWarning 2s infinite;
        }
        
        @keyframes pulseWarning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ç§»é™¤è¡Œé–“è· */
        .row.g-0 {
            margin: 0;
        }
        
        .row.g-0 > [class*="col-"] {
            padding: 0;
        }
        
        /* åƒæ•¸é¡¯ç¤ºå€åŸŸ */
        .parameter-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 0 12px 12px 0;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #dee2e6;
            border-left: none;
            height: 100%;
            min-height: 300px;
            margin-left: -1px;
        }
        
        .parameter-header {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .parameter-header h6 {
            margin: 0;
            color: #495057;
            font-weight: 600;
            font-size: 16px;
        }
        
        .parameter-header button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .parameter-content {
            min-height: 200px;
        }
        
        .no-scan-message {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }
        
        .parameter-item {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .parameter-item.success {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .parameter-item.fail {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        
        .parameter-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .parameter-value {
            font-size: 16px;
            color: #212529;
            word-break: break-all;
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .parameter-value.success {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #155724;
        }
        
        .parameter-value.fail {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #721c24;
        }
        
        .scan-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h2 class="mb-4 text-center">Excelé¢¨æ ¼QRç¢¼æ˜ å°„å·¥å…·</h2>

        <!-- æ”åƒé ­å€ -->
        <div class="camera-section mb-4">
            <div class="camera-header">
                <h4 class="text-center mb-3">ğŸ“· æƒç„ä½ç½®åŠçµæœ</h4>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="camera-status" id="camera-status">ğŸŸ¢ ç›¸æ©Ÿå·²å°±ç·’</div>
                    <div class="scan-result-status" id="scan-result-status" style="display:none;">ğŸ” æƒæçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</div>
                    <div class="duplicate-warning" id="duplicate-warning" style="display:none;">âš ï¸ é‡è¤‡</div>
                </div>
            </div>
            <div class="row g-0">
                <div class="col-md-8">
                    <div id="video-container">
                        <video id="video" class="img-fluid" muted playsinline></video>
                        <canvas id="overlay"></canvas>

                    </div>
                </div>
                <div class="col-md-4">
                    <div class="parameter-display" id="parameter-display">
                        <div class="parameter-header">
                            <h6>ğŸ“‹ ç•¶å‰æƒæçµæœ</h6>
                            <button class="btn btn-sm btn-outline-secondary" id="clear-history" title="æ¸…ç©ºç•¶å‰çµæœ">ğŸ—‘ï¸</button>
                        </div>
                        <div class="parameter-content" id="parameter-content">
                            <div class="no-scan-message">ğŸ” æƒæQRç¢¼å¾Œå°‡é¡¯ç¤ºå°æ‡‰åƒæ•¸</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•¸æ“šè¡¨æ ¼å€ -->
        <div class="table-container">
            <div class="table-header">
                <h5 class="fw-bold">æ•¸æ“šè¡¨æ ¼</h5>
                <div class="table-toolbar">
                    <button class="btn btn-primary btn-sm" id="add-row">â• æ–°å¢è¡Œ</button>
                    <button class="btn btn-danger btn-sm" id="delete-row">â– åˆªé™¤è¡Œ</button>
                    <button class="btn btn-success btn-sm" id="add-column">â• æ–°å¢åˆ—</button>
                    <button class="btn btn-warning btn-sm" id="delete-column">â– åˆªé™¤åˆ—</button>
                    <button class="btn btn-info btn-sm" id="clear-table">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
                    <button class="btn btn-secondary btn-sm" id="export-data">ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</button>
                    <button class="btn btn-dark btn-sm" id="import-data" title="æ”¯æ´TSVã€CSVã€Excelæ ¼å¼">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button>
                    <div class="status-indicator info" id="data-status">
                        ğŸ“Š æ•¸æ“šè¡Œæ•¸: <span id="row-count">1</span> | åˆ—æ•¸: <span id="col-count">2</span>
                        <span id="storage-status" class="ms-2" style="font-size: 0.8em; color: #6c757d;">ğŸ’¾ å·²ä¿å­˜</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            ğŸ’¡ åŒ¯å…¥æ ¼å¼ï¼šTSV (Tabåˆ†éš”)ã€CSV (é€—è™Ÿåˆ†éš”)ã€Excel (.xlsx/.xls)
                        </small>
                    </div>
                </div>
            </div>
            <table class="excel-table" id="excel-table">
                <thead>
                    <tr>
                        <th class="row-number">#</th>
                        <th>å°æ‡‰å€¼1</th>
                        <th>å°æ‡‰å€¼2</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td class="row-number">1</td>
                        <td><input type="text" data-row="0" data-col="0" placeholder="è¼¸å…¥æ•¸æ“š"></td>
                        <td><input type="text" data-row="0" data-col="1" placeholder="è¼¸å…¥æ•¸æ“š"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- èª¿è©¦ä¿¡æ¯ -->
        <div class="debug-section" id="debug-section" style="display: none;">
            <div class="debug-header">
                <h5 class="mb-2">ğŸ”§ èª¿è©¦ä¿¡æ¯</h5>
                <button class="btn btn-sm btn-outline-secondary" id="clear-debug">æ¸…ç©º</button>
            </div>
            <div class="debug-info" id="debug-info">
                <span id="debug-content"></span>
        </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import QrScanner from 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js';

        let tableData = [];
        let scanning = false;
        let selectedCell = null;
        const tableBody = document.getElementById('table-body');
        const resultDiv = document.getElementById('result');
        const overlay = document.getElementById('overlay');
        const context = overlay.getContext('2d');
        const debugInfo = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');
        const scanResultStatus = document.getElementById('scan-result-status');
        
        // ç•¶å‰æƒæçµæœ
        let currentScanResult = null;

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatus() {
            const rowCount = tableBody.rows.length;
            const colCount = tableBody.rows[0] ? tableBody.rows[0].cells.length - 1 : 0; // æ¸›å»è¡Œè™Ÿåˆ—
            document.getElementById('row-count').textContent = rowCount;
            document.getElementById('col-count').textContent = colCount;
        }

        // é¡¯ç¤ºèª¿è©¦ä¿¡æ¯
        function showDebugInfo(message) {
            debugContent.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            document.getElementById('debug-section').style.display = 'block';
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // æ¸…ç©ºèª¿è©¦ä¿¡æ¯
        function clearDebugInfo() {
            debugContent.innerHTML = '';
            document.getElementById('debug-section').style.display = 'none';
        }
        
        // æ¸…ç©ºç•¶å‰æƒæçµæœ
        function clearScanHistory() {
            currentScanResult = null;
            updateParameterDisplay();
            showDebugInfo('å·²æ¸…ç©ºç•¶å‰æƒæçµæœ');
        }

        // åˆå§‹åŒ–è¡¨æ ¼æ•¸æ“š
        function initializeTableData() {
            tableData = [];
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = [];
                const inputs = rows[i].getElementsByTagName('input');
                for (let j = 0; j < inputs.length; j++) {
                    row.push(inputs[j].value.trim());
                }
                tableData.push(row);
            }
            showDebugInfo(`è¡¨æ ¼æ•¸æ“šå·²æ›´æ–°: ${JSON.stringify(tableData)}`);
        }

        // ä¿å­˜è¡¨æ ¼æ•¸æ“šåˆ°æœ¬åœ°å­˜å„²
        function saveTableData() {
            try {
                localStorage.setItem('qrMappingTableData', JSON.stringify(tableData));
                showDebugInfo('è¡¨æ ¼æ•¸æ“šå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å„²');
                
                // æ›´æ–°å­˜å„²ç‹€æ…‹é¡¯ç¤º
                const storageStatus = document.getElementById('storage-status');
                storageStatus.textContent = 'ğŸ’¾ å·²ä¿å­˜';
                storageStatus.style.color = '#28a745';
                
                // 2ç§’å¾Œæ¢å¾©é»˜èªç‹€æ…‹
                setTimeout(() => {
                    storageStatus.textContent = 'ğŸ’¾ å·²ä¿å­˜';
                    storageStatus.style.color = '#6c757d';
                }, 2000);
            } catch (error) {
                showDebugInfo('ä¿å­˜å¤±æ•—: ' + error.message);
                
                // é¡¯ç¤ºä¿å­˜å¤±æ•—ç‹€æ…‹
                const storageStatus = document.getElementById('storage-status');
                storageStatus.textContent = 'âŒ ä¿å­˜å¤±æ•—';
                storageStatus.style.color = '#dc3545';
            }
        }

        // å¾æœ¬åœ°å­˜å„²åŠ è¼‰è¡¨æ ¼æ•¸æ“š
        function loadTableData() {
            try {
                const savedData = localStorage.getItem('qrMappingTableData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (Array.isArray(data) && data.length > 0) {
                        renderTableFromData(data);
                        showDebugInfo('å·²å¾æœ¬åœ°å­˜å„²åŠ è¼‰è¡¨æ ¼æ•¸æ“š');
                        
                        // æ›´æ–°å­˜å„²ç‹€æ…‹é¡¯ç¤º
                        const storageStatus = document.getElementById('storage-status');
                        storageStatus.textContent = 'ğŸ’¾ å·²åŠ è¼‰';
                        storageStatus.style.color = '#17a2b8';
                        
                        return true;
                    }
                }
                return false;
            } catch (error) {
                showDebugInfo('åŠ è¼‰å¤±æ•—: ' + error.message);
                return false;
            }
        }

        // å¾æ•¸æ“šæ¸²æŸ“è¡¨æ ¼
        function renderTableFromData(data) {
            // æ¸…ç©ºç¾æœ‰è¡¨æ ¼
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                showDebugInfo('æ²’æœ‰æ•¸æ“šå¯æ¸²æŸ“');
                return;
            }
            
            // æ‰¾å‡ºæœ€å¤§åˆ—æ•¸
            const maxCols = Math.max(...data.map(row => row ? row.length : 0));
            
            // æ›´æ–°è¡¨é ­
            const headerRow = document.querySelector('#excel-table thead tr');
            headerRow.innerHTML = '<th class="row-number">#</th>';
            for (let i = 0; i < maxCols; i++) {
                const headerCell = document.createElement('th');
                headerCell.textContent = `å°æ‡‰å€¼${i + 1}`;
                headerRow.appendChild(headerCell);
            }
            
            // æ¸²æŸ“æ•¸æ“šè¡Œ
            data.forEach((row, rowIndex) => {
                const newRow = document.createElement('tr');
                
                // æ·»åŠ è¡Œè™Ÿ
                const rowNumberCell = document.createElement('td');
                rowNumberCell.className = 'row-number';
                rowNumberCell.textContent = rowIndex + 1;
                newRow.appendChild(rowNumberCell);
                
                // æ·»åŠ æ•¸æ“šåˆ—
                for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    
                    // è™•ç†Excelæ•¸æ“šä¸­çš„ç©ºå€¼
                    let cellValue = '';
                    if (row && row[colIndex] !== null && row[colIndex] !== undefined) {
                        cellValue = row[colIndex].toString().trim();
                    }
                    
                    input.value = cellValue;
                    input.dataset.row = rowIndex;
                    input.dataset.col = colIndex;
                    input.placeholder = 'è¼¸å…¥æ•¸æ“š';
                    input.addEventListener('input', updateTableData);
                    input.addEventListener('focus', () => selectCell(input));
                    td.appendChild(input);
                    newRow.appendChild(td);
                }
                
                tableBody.appendChild(newRow);
            });
            
            updateTableData();
        }



        // é˜²æŠ–ä¿å­˜è¨ˆæ™‚å™¨
        let saveTimeout = null;

        // æ›´æ–°è¡¨æ ¼æ•¸æ“š
        function updateTableData() {
            initializeTableData();
            updateStatus();
            
            // é˜²æŠ–ä¿å­˜ï¼Œé¿å…éæ–¼é »ç¹çš„ä¿å­˜æ“ä½œ
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(() => {
                saveTableData();
            }, 1000); // 1ç§’å¾Œä¿å­˜
        }

        // æ–°å¢è¡Œ
        function addRow() {
            const rowCount = tableBody.rows.length;
            const colCount = tableBody.rows[0] ? tableBody.rows[0].cells.length - 1 : 2; // æ¸›å»è¡Œè™Ÿåˆ—ï¼Œé è¨­2åˆ—
            const newRow = document.createElement('tr');
            
            // æ·»åŠ è¡Œè™Ÿ
            const rowNumberCell = document.createElement('td');
            rowNumberCell.className = 'row-number';
            rowNumberCell.textContent = rowCount + 1;
            newRow.appendChild(rowNumberCell);
            
            for (let i = 0; i < colCount; i++) {
                const cell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.dataset.row = rowCount;
                input.dataset.col = i;
                input.placeholder = 'è¼¸å…¥æ•¸æ“š';
                input.addEventListener('input', updateTableData);
                input.addEventListener('focus', () => selectCell(input));
                cell.appendChild(input);
                newRow.appendChild(cell);
            }
            
            tableBody.appendChild(newRow);
            updateTableData();
            showDebugInfo(`æ–°å¢è¡Œ: ${rowCount + 1}`);
        }

        // åˆªé™¤è¡Œ
        function deleteRow() {
            if (tableBody.rows.length > 1) {
                tableBody.deleteRow(tableBody.rows.length - 1);
                updateTableData();
                showDebugInfo('åˆªé™¤æœ€å¾Œä¸€è¡Œ');
            }
        }

        // æ–°å¢åˆ—
        function addColumn() {
            const rows = tableBody.getElementsByTagName('tr');
            const colCount = rows[0] ? rows[0].cells.length - 1 : 0; // æ¸›å»è¡Œè™Ÿåˆ—
            
            for (let i = 0; i < rows.length; i++) {
                const cell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.dataset.row = i;
                input.dataset.col = colCount;
                input.placeholder = 'è¼¸å…¥æ•¸æ“š';
                input.addEventListener('input', updateTableData);
                input.addEventListener('focus', () => selectCell(input));
                cell.appendChild(input);
                rows[i].appendChild(cell);
            }
            
            // æ›´æ–°è¡¨é ­
            const headerRow = document.querySelector('#excel-table thead tr');
            const headerCell = document.createElement('th');
            headerCell.textContent = `å°æ‡‰å€¼${colCount + 1}`;
            headerRow.appendChild(headerCell);
            
            updateTableData();
            showDebugInfo(`æ–°å¢åˆ—: å°æ‡‰å€¼${colCount + 1}`);
        }

        // åˆªé™¤åˆ—
        function deleteColumn() {
            const rows = tableBody.getElementsByTagName('tr');
            if (rows[0] && rows[0].cells.length > 3) { // è‡³å°‘ä¿ç•™è¡Œè™Ÿåˆ—å’Œ2å€‹æ•¸æ“šåˆ—
                for (let i = 0; i < rows.length; i++) {
                    rows[i].deleteCell(rows[i].cells.length - 1);
                }
                
                // æ›´æ–°è¡¨é ­
                const headerRow = document.querySelector('#excel-table thead tr');
                if (headerRow.cells.length > 1) {
                    headerRow.deleteCell(headerRow.cells.length - 1);
                }
                
                updateTableData();
                showDebugInfo('åˆªé™¤æœ€å¾Œä¸€åˆ—');
            }
        }

        // æ¸…ç©ºè¡¨æ ¼ä¸¦é‚„åŸé è¨­
        function clearTable() {
            // æ¸…ç©ºè¡¨æ ¼å…§å®¹
            tableBody.innerHTML = '';
            
            // é‚„åŸç‚ºé è¨­çš„1è¡Œ2åˆ—
            const newRow = document.createElement('tr');
            
            // æ·»åŠ è¡Œè™Ÿ
            const rowNumberCell = document.createElement('td');
            rowNumberCell.className = 'row-number';
            rowNumberCell.textContent = '1';
            newRow.appendChild(rowNumberCell);
            
            // æ·»åŠ 2å€‹æ•¸æ“šåˆ—
            for (let i = 0; i < 2; i++) {
                const cell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.dataset.row = 0;
                input.dataset.col = i;
                input.placeholder = 'è¼¸å…¥æ•¸æ“š';
                input.addEventListener('input', updateTableData);
                input.addEventListener('focus', () => selectCell(input));
                cell.appendChild(input);
                newRow.appendChild(cell);
            }
            
            tableBody.appendChild(newRow);
            
            // é‚„åŸè¡¨é ­ç‚º2åˆ—
            const headerRow = document.querySelector('#excel-table thead tr');
            headerRow.innerHTML = `
                <th class="row-number">#</th>
                <th>å°æ‡‰å€¼1</th>
                <th>å°æ‡‰å€¼2</th>
            `;
            
            updateTableData();
            // æ¸…é™¤æœ¬åœ°å­˜å„²
            try {
                localStorage.removeItem('qrMappingTableData');
                showDebugInfo('å·²æ¸…é™¤æœ¬åœ°å­˜å„²çš„è¡¨æ ¼æ•¸æ“š');
                
                // æ›´æ–°å­˜å„²ç‹€æ…‹é¡¯ç¤º
                const storageStatus = document.getElementById('storage-status');
                storageStatus.textContent = 'ğŸ—‚ï¸ å·²æ¸…é™¤';
                storageStatus.style.color = '#dc3545';
            } catch (error) {
                showDebugInfo('æ¸…é™¤æœ¬åœ°å­˜å„²å¤±æ•—: ' + error.message);
            }
            showDebugInfo('æ¸…ç©ºè¡¨æ ¼ä¸¦é‚„åŸé è¨­');
        }

        // é¸ä¸­å–®å…ƒæ ¼
        function selectCell(input) {
            if (selectedCell) {
                selectedCell.classList.remove('selected');
            }
            selectedCell = input;
            input.classList.add('selected');
        }

        // åŒ¯å‡ºæ•¸æ“š
        function exportData() {
            const csvContent = tableData.map(row => row.join('\t')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'qr_mapping_data.tsv';
            a.click();
            URL.revokeObjectURL(url);
            showDebugInfo('åŒ¯å‡ºæ•¸æ“šå®Œæˆ');
        }

        // åŒ¯å…¥æ•¸æ“š
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.tsv,.csv,.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name.toLowerCase();
                    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                    
                    if (isExcel) {
                        // æª¢æŸ¥SheetJSåº«æ˜¯å¦å¯ç”¨
                        if (typeof XLSX === 'undefined') {
                            showDebugInfo('Excelè§£æåº«æœªåŠ è¼‰ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
                            alert('Excelè§£æåº«æœªåŠ è¼‰ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥å¾Œé‡è©¦');
                            return;
                        }
                        
                        // è™•ç†Excelæ–‡ä»¶
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                
                                // ç²å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                
                                // å°‡å·¥ä½œè¡¨è½‰æ›ç‚ºJSONæ•¸çµ„
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                
                                // éæ¿¾ç©ºè¡Œ
                                const filteredData = jsonData.filter(row => 
                                    row && row.length > 0 && row.some(cell => cell !== null && cell !== undefined && cell.toString().trim() !== '')
                                );
                                
                                if (filteredData.length === 0) {
                                    showDebugInfo('Excelæ–‡ä»¶ç‚ºç©ºæˆ–åªåŒ…å«ç©ºè¡Œ');
                                    return;
                                }
                                
                                // æ¸²æŸ“è¡¨æ ¼
                                renderTableFromData(filteredData);
                                showDebugInfo(`åŒ¯å…¥Excelæ•¸æ“š: ${filteredData.length} è¡Œ`);
                            } catch (error) {
                                showDebugInfo('Excelæ–‡ä»¶è§£æå¤±æ•—: ' + error.message);
                                alert('Excelæ–‡ä»¶è§£æå¤±æ•—: ' + error.message);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        // è™•ç†æ–‡æœ¬æ–‡ä»¶ï¼ˆTSVã€CSVã€TXTï¼‰
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const content = e.target.result;
                            const lines = content.split('\n').filter(line => line.trim()); // éæ¿¾ç©ºè¡Œ
                            
                            if (lines.length === 0) {
                                showDebugInfo('åŒ¯å…¥æ–‡ä»¶ç‚ºç©ºæˆ–åªåŒ…å«ç©ºè¡Œ');
                                return;
                            }
                            
                            // è§£ææ•¸æ“š
                            const data = lines.map(line => line.split('\t').map(cell => cell.trim()));
                            
                            // æ¸²æŸ“è¡¨æ ¼
                            renderTableFromData(data);
                            showDebugInfo(`åŒ¯å…¥æ–‡æœ¬æ•¸æ“š: ${lines.length} è¡Œ`);
                        };
                        reader.readAsText(file);
                    }
                }
            };
            input.click();
        }

        // éµç›¤äº‹ä»¶è™•ç†
        document.addEventListener('keydown', function(e) {
            if (selectedCell) {
                const row = parseInt(selectedCell.dataset.row);
                const col = parseInt(selectedCell.dataset.col);
                const rows = tableBody.getElementsByTagName('tr');
                
                switch(e.key) {
                    case 'Tab':
                        e.preventDefault();
                        if (e.shiftKey) {
                            // å‘å·¦ç§»å‹•
                            if (col > 0) {
                                rows[row].cells[col].querySelector('input').focus();
                            } else if (row > 0) {
                                rows[row - 1].cells[rows[row - 1].cells.length - 1].querySelector('input').focus();
                            }
                        } else {
                            // å‘å³ç§»å‹•
                            if (col < rows[row].cells.length - 2) { // æ¸›å»è¡Œè™Ÿåˆ—
                                rows[row].cells[col + 2].querySelector('input').focus();
                            } else {
                                // å¦‚æœæ˜¯æœ€å¾Œä¸€åˆ—ï¼Œæ–°å¢ä¸€åˆ—
                                addColumn();
                                // èšç„¦åˆ°æ–°åˆ—çš„è¼¸å…¥æ¡†
                                setTimeout(() => {
                                    rows[row].cells[rows[row].cells.length - 1].querySelector('input').focus();
                                }, 100);
                            }
                        }
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (row < rows.length - 1) {
                            rows[row + 1].cells[col + 1].querySelector('input').focus();
                        } else {
                            // å¦‚æœæ˜¯æœ€å¾Œä¸€è¡Œï¼Œæ–°å¢ä¸€è¡Œ
                            addRow();
                            // èšç„¦åˆ°æ–°è¡Œçš„å°æ‡‰åˆ—
                            setTimeout(() => {
                                const newRows = tableBody.getElementsByTagName('tr');
                                newRows[newRows.length - 1].cells[col + 1].querySelector('input').focus();
                            }, 100);
                        }
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        if (row > 0) {
                            rows[row - 1].cells[col + 1].querySelector('input').focus();
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (row < rows.length - 1) {
                            rows[row + 1].cells[col + 1].querySelector('input').focus();
                        }
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        if (col > 0) {
                            rows[row].cells[col].querySelector('input').focus();
                        }
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        if (col < rows[row].cells.length - 2) { // æ¸›å»è¡Œè™Ÿåˆ—
                            rows[row].cells[col + 2].querySelector('input').focus();
                        }
                        break;
                }
                }
            });

        // è¤‡è£½è²¼ä¸Šè™•ç†
        document.addEventListener('paste', function(e) {
            if (selectedCell) {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text');
                const lines = pastedData.split('\n');
                
                let startRow = parseInt(selectedCell.dataset.row);
                let startCol = parseInt(selectedCell.dataset.col);
                
                // éæ¿¾æ‰ç©ºè¡Œå’ŒåªåŒ…å«ç©ºç™½å­—ç¬¦çš„è¡Œ
                const validLines = lines.filter(line => line.trim() !== '');
                
                if (validLines.length === 0) {
                    showDebugInfo('è²¼ä¸Šæ•¸æ“šç‚ºç©ºæˆ–åªåŒ…å«ç©ºè¡Œ');
                    return;
                }
                
                validLines.forEach((line, rowOffset) => {
                    const cells = line.split('\t');
                    const currentRow = startRow + rowOffset;
                    
                    // ç¢ºä¿è¡Œå­˜åœ¨
                    while (currentRow >= tableBody.rows.length) {
                        addRow();
                    }
                    
                    cells.forEach((cell, colOffset) => {
                        const currentCol = startCol + colOffset;
                        const row = tableBody.rows[currentRow];
                        
                        // ç¢ºä¿åˆ—å­˜åœ¨
                        while (currentCol >= row.cells.length - 1) { // æ¸›å»è¡Œè™Ÿåˆ—
                            addColumn();
                        }
                        
                        const input = row.cells[currentCol + 1].querySelector('input'); // +1 å› ç‚ºæœ‰è¡Œè™Ÿåˆ—
                        if (input) {
                            input.value = cell.trim();
                            input.placeholder = 'è¼¸å…¥æ•¸æ“š';
                        }
                    });
                });
                
                updateTableData();
                showDebugInfo(`è²¼ä¸Šæ•¸æ“š: ${validLines.length} è¡Œ`);
            }
        });

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('add-row').addEventListener('click', addRow);
        document.getElementById('delete-row').addEventListener('click', deleteRow);
        document.getElementById('add-column').addEventListener('click', addColumn);
        document.getElementById('delete-column').addEventListener('click', deleteColumn);
        document.getElementById('clear-table').addEventListener('click', clearTable);
        document.getElementById('export-data').addEventListener('click', exportData);
        document.getElementById('import-data').addEventListener('click', importData);
        document.getElementById('clear-debug').addEventListener('click', clearDebugInfo);
        document.getElementById('clear-history').addEventListener('click', clearScanHistory);

        // åˆå§‹åŒ–è¡¨æ ¼äº‹ä»¶
        const inputs = tableBody.getElementsByTagName('input');
        for (let input of inputs) {
            input.addEventListener('input', updateTableData);
            input.addEventListener('focus', () => selectCell(input));
        }

        // é é¢åŠ è¼‰æ™‚è‡ªå‹•åŠ è¼‰æœ¬åœ°å­˜å„²çš„æ•¸æ“š
        document.addEventListener('DOMContentLoaded', function() {
            // å˜—è©¦åŠ è¼‰æœ¬åœ°å­˜å„²çš„æ•¸æ“š
            if (!loadTableData()) {
                // å¦‚æœæ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œåˆå§‹åŒ–ç‚ºé è¨­ç‹€æ…‹
                updateTableData();
                showDebugInfo('é é¢åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨é è¨­è¡¨æ ¼');
            } else {
                showDebugInfo('é é¢åˆå§‹åŒ–å®Œæˆï¼Œå·²åŠ è¼‰ä¿å­˜çš„æ•¸æ“š');
            }
            
            // åˆå§‹åŒ–åƒæ•¸é¡¯ç¤º
            updateParameterDisplay();
        });

        // QR æƒæç›¸é—œ
        async function startCamera() {
            const cameraStatus = document.getElementById('camera-status');
            try {
                cameraStatus.textContent = 'ğŸŸ¡ æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...';
                cameraStatus.style.background = '#fff3cd';
                cameraStatus.style.color = '#856404';
                cameraStatus.style.borderColor = '#ffeaa7';
                
                const stream = await navigator.mediaDevices.getUserMedia({
				  video: {
                        width: { ideal: 1920 },
					height: { ideal: 1080 },
                        facingMode: 'environment',
                        focusMode: 'continuous',
					zoom: { ideal: 2 },
                        focusDistance: { ideal: 0.1 }
				  }
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();

                video.addEventListener('loadedmetadata', () => {
                    overlay.width = video.videoWidth;
                    overlay.height = video.videoHeight;
                    requestAnimationFrame(() => captureFrame(video));
                    
                    cameraStatus.textContent = 'ğŸŸ¢ ç›¸æ©Ÿå·²å°±ç·’';
                    cameraStatus.style.background = '#d4edda';
                    cameraStatus.style.color = '#155724';
                    cameraStatus.style.borderColor = '#c3e6cb';
                });
            } catch (error) {
                console.error('ç„¡æ³•è¨ªå•ç›¸æ©Ÿ:', error);
                cameraStatus.textContent = 'ğŸ”´ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—';
                cameraStatus.style.background = '#f8d7da';
                cameraStatus.style.color = '#721c24';
                cameraStatus.style.borderColor = '#f5c6cb';
                
                resultDiv.textContent = 'ç„¡æ³•å•Ÿå‹•æ”åƒé ­ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–è¨­å‚™';
                resultDiv.className = 'alert alert-danger text-center';
            }
        }

        function showScanResultStatus(type, text) {
            scanResultStatus.textContent = text;
            scanResultStatus.className = 'scan-result-status ' + type;
            scanResultStatus.style.display = '';
        }

        function showDuplicateWarning(count) {
            const duplicateWarning = document.getElementById('duplicate-warning');
            if (count > 1) {
                duplicateWarning.textContent = `âš ï¸ ${count}å€‹é‡è¤‡`;
                duplicateWarning.style.display = '';
            } else {
                duplicateWarning.style.display = 'none';
            }
        }

        function captureFrame(video) {
            if (scanning) return;
            context.clearRect(0, 0, overlay.width, overlay.height);
            context.drawImage(video, 0, 0, overlay.width, overlay.height);
            QrScanner.scanImage(overlay, { returnDetailedScanResult: true })
                .then(result => {
                    if (result) {
                        const scannedQrCodeNumber = result.data.trim();
                        if (!scannedQrCodeNumber) {
                            // æƒæåˆ°ç©ºå€¼ï¼Œç›´æ¥å¿½ç•¥
                            requestAnimationFrame(() => captureFrame(video));
                            return;
                        }
                        showDebugInfo(`æƒæåˆ°QRç¢¼: "${scannedQrCodeNumber}"`);
                        showDebugInfo(`ç•¶å‰è¡¨æ ¼æ•¸æ“š: ${JSON.stringify(tableData)}`);
                        
                        // åœ¨æ‰€æœ‰è¡Œå’Œæ‰€æœ‰åˆ—ä¸­æŸ¥æ‰¾åŒ¹é…çš„QRç¢¼
                        let matchedRows = [];
                        
                        for (let rowIndex = 0; rowIndex < tableData.length; rowIndex++) {
                            const row = tableData[rowIndex];
                            for (let colIndex = 0; colIndex < row.length; colIndex++) {
                                if (row[colIndex] === scannedQrCodeNumber) {
                                    matchedRows.push({
                                        row: row,
                                        col: colIndex,
                                        rowIndex: rowIndex
                                    });
                                }
                            }
                        }
                        
                        if (matchedRows.length > 0) {
                            displayParameterBatch(matchedRows);
                            showScanResultStatus('success', `âœ… æ‰¾åˆ°åŒ¹é…`);
                            showDebugInfo(`åŒ¹é…æˆåŠŸ: æ‰¾åˆ°${matchedRows.length}å€‹åŒ¹é…`);
                            showDuplicateWarning(matchedRows.length);
                            
                            highlightAndScrollToRows(matchedRows);
                        } else {
                            displayParameterNotFoundBatch(scannedQrCodeNumber);
                            showScanResultStatus('fail', `âŒ æœªæ‰¾åˆ°`);
                            showDebugInfo(`åŒ¹é…å¤±æ•—: æœªæ‰¾åˆ° "${scannedQrCodeNumber}"`);
                            showDuplicateWarning(0);
                        }
                        drawHighlight(result);
                        scanning = true;
                        setTimeout(() => {
                            scanning = false;
                            requestAnimationFrame(() => captureFrame(video));
                        }, 500);
                    } else {
                        requestAnimationFrame(() => captureFrame(video));
                    }
                })
                .catch(() => {
                    requestAnimationFrame(() => captureFrame(video));
                });
        }

        // é«˜äº®æ‰€æœ‰åŒ¹é…çš„è¡Œä¸¦æ»¾å‹•åˆ°ç¬¬ä¸€å€‹åŒ¹é…çš„è¡Œ
        function highlightAndScrollToRows(matchedRows) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            const allRows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < allRows.length; i++) {
                allRows[i].classList.remove('matched-row');
                allRows[i].classList.remove('duplicate-row');
            }
            
            // é«˜äº®æ‰€æœ‰åŒ¹é…çš„è¡Œ
            matchedRows.forEach((match, index) => {
                const rowIndex = match.rowIndex;
                if (allRows[rowIndex]) {
                    if (index === 0) {
                        // ç¬¬ä¸€å€‹åŒ¹é…ç”¨ç¶ è‰²é«˜äº®
                        allRows[rowIndex].classList.add('matched-row');
                    } else {
                        // å¾ŒçºŒé‡è¤‡ç”¨æ©™è‰²é«˜äº®
                        allRows[rowIndex].classList.add('duplicate-row');
                    }
                }
            });
            
            // æ»¾å‹•åˆ°ç¬¬ä¸€å€‹åŒ¹é…çš„è¡Œ
            if (matchedRows.length > 0) {
                const firstMatch = matchedRows[0];
                const tableContainer = document.querySelector('.table-container');
                const rowElement = allRows[firstMatch.rowIndex];
                const rowTop = rowElement.offsetTop;
                const containerHeight = tableContainer.clientHeight;
                
                // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼Œè®“ç¬¬ä¸€å€‹åŒ¹é…çš„è¡Œåœ¨å®¹å™¨ä¸­é–“
                const scrollTo = rowTop - containerHeight / 2 + rowElement.offsetHeight / 2;
                
                tableContainer.scrollTo({
                    top: scrollTo,
                    behavior: 'smooth'
                });
            }
        }

        function drawHighlight(result) {
            if (result.cornerPoints && result.cornerPoints.length === 4) {
                context.beginPath();
                context.lineWidth = 4;
                context.strokeStyle = 'red';
                context.moveTo(result.cornerPoints[0].x, result.cornerPoints[0].y);
                for (let i = 1; i < result.cornerPoints.length; i++) {
                    context.lineTo(result.cornerPoints[i].x, result.cornerPoints[i].y);
                }
                context.closePath();
                context.stroke();
            }
        }

        // åƒæ•¸é¡¯ç¤ºç›¸é—œå‡½æ•¸
        function displayParameterBatch(matchedRows) {
            const currentTime = new Date().toLocaleTimeString();
            // åªé¡¯ç¤ºç¬¬ä¸€å€‹åŒ¹é…çµæœ
            const match = matchedRows[0];
            currentScanResult = {
                qrCode: match.row[match.col],
                parameter: `ç¬¬${match.rowIndex + 1}è¡Œ, ç¬¬${match.col + 1}åˆ—` + (match.row[match.col] ? `\nå€¼: ${match.row[match.col]}` : ''),
                time: currentTime,
                status: 'success',
                rowNumber: match.rowIndex + 1,
                colNumber: match.col + 1
            };
            updateParameterDisplay();
        }

        function displayParameterNotFoundBatch(qrCode) {
            const currentTime = new Date().toLocaleTimeString();
            currentScanResult = {
                qrCode: qrCode,
                parameter: 'âŒ æœªæ‰¾åˆ°å°æ‡‰æ•¸æ“š',
                time: currentTime,
                status: 'fail',
                rowNumber: null,
                colNumber: null
            };
            updateParameterDisplay();
        }

        function updateParameterDisplay() {
            const parameterContent = document.getElementById('parameter-content');
            if (!currentScanResult) {
                parameterContent.innerHTML = `
                    <div class="no-scan-message">ğŸ” æƒæQRç¢¼å¾Œå°‡é¡¯ç¤ºå°æ‡‰åƒæ•¸</div>
                `;
                return;
            }
            let rowInfo = '';
            if (currentScanResult.rowNumber && currentScanResult.colNumber) {
                rowInfo = ` (ç¬¬${currentScanResult.rowNumber}è¡Œ, ç¬¬${currentScanResult.colNumber}åˆ—)`;
            } else if (currentScanResult.rowNumber) {
                rowInfo = ` (ç¬¬${currentScanResult.rowNumber}è¡Œ)`;
            }
            parameterContent.innerHTML = `
                <div class="parameter-item ${currentScanResult.status}">
                    <div class="parameter-label">å…§å®¹: ${currentScanResult.qrCode}${rowInfo}</div>
                    <div class="parameter-value ${currentScanResult.status}">${currentScanResult.parameter.replace(/\n/g, '<br>')}</div>
                    <div class="scan-time">æƒææ™‚é–“: ${currentScanResult.time}</div>
                </div>
            `;
        }

        // åˆå§‹åŒ–
        updateTableData();
        startCamera();
        scanResultStatus.textContent = 'ğŸ” æƒæçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡';
        scanResultStatus.className = 'scan-result-status info';
        scanResultStatus.style.display = '';

        // æ¸…ç†è³‡æº
        window.addEventListener('unload', () => {
            const video = document.getElementById('video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
