<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éŒ¢åŒ…æ‰‹å‹•ç°½åå·¥å…· - å¤šéˆå¤šéŒ¢åŒ…</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
      height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
      padding: 30px 40px;
      max-width: 1600px;
      width: 100%;
      max-height: 95vh;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .left-column, .right-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .button-group-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    h1 {
      color: #1a1a1a;
      margin-bottom: 8px;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
      font-weight: 400;
    }

    .input-group {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      height: fit-content;
    }

    .input-group label {
      margin-bottom: 8px;
    }

    .input-group textarea {
      margin-bottom: 0;
    }

    .network-selector {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      height: fit-content;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #1a1a1a;
      font-weight: 600;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 14px;
      background-color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    select:hover {
      border-color: #667eea;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      transition: all 0.3s ease;
      min-height: 120px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    textarea:hover {
      border-color: #667eea;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }

    button {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    button:active:not(:disabled) {
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-metamask {
      background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
      color: white;
    }

    .btn-phantom {
      background: linear-gradient(135deg, #ab9ff2 0%, #8b7fce 100%);
      color: white;
    }

    .btn-coinbase {
      background: linear-gradient(135deg, #1652f0 0%, #0052cc 100%);
      color: white;
    }

    .btn-trust {
      background: linear-gradient(135deg, #3375bb 0%, #1a4d7a 100%);
      color: white;
    }

    .btn-okx {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      color: white;
    }

    .btn-solflare {
      background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
      color: #000;
    }

    .btn-copy {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-top: 10px;
      width: 100%;
    }

    .btn-copy:hover:not(:disabled) {
      background: linear-gradient(135deg, #5568d3 0%, #663d8f 100%);
    }

    .result-section {
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      flex: 1;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 2px solid #dee2e6;
    }

    .result-title {
      color: #1a1a1a;
      font-size: 18px;
      font-weight: 700;
    }

    #result {
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 16px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      color: #1a1a1a;
      line-height: 1.7;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      flex: 1;
    }

    .result-empty {
      color: #999;
      font-style: italic;
    }

    .status {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      display: none;
      font-weight: 500;
    }

    .status.success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 2px solid #b1dfbb;
      display: block;
    }

    .status.error {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 2px solid #f1b0b7;
      display: block;
    }

    .status.info {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border: 2px solid #abdde5;
      display: block;
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .wallet-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      padding: 14px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      font-size: 13px;
      color: #495057;
      border: 2px solid #dee2e6;
      flex-wrap: wrap;
    }

    .wallet-info strong {
      color: #1a1a1a;
    }

    .wallet-address {
      font-family: 'Courier New', monospace;
      color: #667eea;
      font-weight: 600;
    }

    #walletStatus {
      background: white;
      padding: 16px 20px;
      border-radius: 10px;
      border: 2px solid #dee2e6;
    }

    #walletStatus > div {
      padding: 6px 0;
      font-size: 13px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” éŒ¢åŒ…æ‰‹å‹•ç°½åå·¥å…·</h1>
    <p class="subtitle">æ”¯æ´ MetaMaskã€Coinbaseã€Trust Walletã€OKXã€Phantomã€Solflare ç°½å</p>

    <div class="main-content">
      <!-- å·¦æ¬„ï¼šéŒ¢åŒ…é¸æ“‡ -->
      <div class="left-column">
        <div class="network-selector">
          <label for="network">é¸æ“‡ç¶²çµ¡ï¼ˆEVM éŒ¢åŒ…ï¼‰ï¼š</label>
          <select id="network">
            <optgroup label="ä»¥å¤ªåŠ">
              <option value="ethereum-mainnet">ä»¥å¤ªåŠä¸»ç¶²</option>
              <option value="sepolia">Sepolia æ¸¬è©¦ç¶²</option>
              <option value="holesky">Holesky æ¸¬è©¦ç¶²</option>
            </optgroup>
            <optgroup label="ç¬¬äºŒå±¤">
              <option value="polygon">Polygonï¼ˆmaticï¼‰</option>
              <option value="arbitrum">Arbitrum One</option>
              <option value="optimism">Optimism</option>
              <option value="base">Base</option>
            </optgroup>
            <optgroup label="å…¶ä»–">
              <option value="bsc">å¹£å®‰æ™ºèƒ½éˆï¼ˆBSCï¼‰</option>
              <option value="avalanche">Avalanche C-Chain</option>
              <option value="fantom">Fantom</option>
            </optgroup>
          </select>
        </div>

        <div class="button-group">
          <button class="btn-metamask" onclick="signWithMetaMask()" id="btnMetaMask">
            <span id="metaMaskText">ğŸ¦Š MetaMask</span>
          </button>
          <button class="btn-coinbase" onclick="signWithCoinbase()" id="btnCoinbase">
            <span id="coinbaseText">ğŸ’° Coinbase</span>
          </button>
          <button class="btn-trust" onclick="signWithTrust()" id="btnTrust">
            <span id="trustText">ğŸ” Trust Wallet</span>
          </button>
          <button class="btn-okx" onclick="signWithOKX()" id="btnOKX">
            <span id="okxText">ğŸª™ OKX Wallet</span>
          </button>
          <button class="btn-phantom" onclick="signWithPhantom()" id="btnPhantom">
            <span id="phantomText">ğŸ‘» Phantom</span>
          </button>
          <button class="btn-solflare" onclick="signWithSolflare()" id="btnSolflare">
            <span id="solflareText">â˜€ï¸ Solflare</span>
          </button>
        </div>

        <div id="walletStatus">
          <div id="metaMaskStatus"></div>
          <div id="coinbaseStatus"></div>
          <div id="trustStatus"></div>
          <div id="okxStatus"></div>
          <div id="phantomStatus"></div>
          <div id="solflareStatus"></div>
        </div>
      </div>

      <!-- å³æ¬„ï¼šè¼¸å…¥èˆ‡çµæœå€åŸŸ -->
      <div class="right-column">
        <div class="input-group">
          <label for="message">è¼¸å…¥å¾…ç°½åçš„è¨Šæ¯ï¼š</label>
          <textarea id="message" rows="6" placeholder="è«‹åœ¨æ­¤è¼¸å…¥è¦ç°½åçš„å…§å®¹..."></textarea>
        </div>

        <div class="result-section">
          <div class="result-header">
            <span class="result-title">ç°½åçµæœï¼š</span>
          </div>
          <div id="walletInfo"></div>
          <pre id="result" class="result-empty">ç­‰å¾…ç°½å...</pre>
          <button class="btn-copy" onclick="copyResult()" id="btnCopy" style="display: none;">
            è¤‡è£½ç°½åçµæœ
          </button>
          <div id="status" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç¶²çµ¡é…ç½®
    const networkConfig = {
      'ethereum-mainnet': {
        name: 'ä»¥å¤ªåŠä¸»ç¶²',
        chainId: '0x1',
        chainIdInt: 1,
        rpcUrl: 'https://eth-mainnet.alchemyapi.io/v2/demo',
        symbol: 'ETH',
        blockExplorer: 'https://etherscan.io'
      },
      'sepolia': {
        name: 'Sepolia æ¸¬è©¦ç¶²',
        chainId: '0xaa36a7',
        chainIdInt: 11155111,
        rpcUrl: 'https://eth-sepolia.alchemyapi.io/v2/demo',
        symbol: 'ETH',
        blockExplorer: 'https://sepolia.etherscan.io'
      },
      'holesky': {
        name: 'Holesky æ¸¬è©¦ç¶²',
        chainId: '0x4268',
        chainIdInt: 17000,
        rpcUrl: 'https://eth-holesky.alchemyapi.io/v2/demo',
        symbol: 'ETH',
        blockExplorer: 'https://holesky.etherscan.io'
      },
      'polygon': {
        name: 'Polygon',
        chainId: '0x89',
        chainIdInt: 137,
        rpcUrl: 'https://polygon-rpc.com',
        symbol: 'MATIC',
        blockExplorer: 'https://polygonscan.com'
      },
      'arbitrum': {
        name: 'Arbitrum One',
        chainId: '0xa4b1',
        chainIdInt: 42161,
        rpcUrl: 'https://arb1.arbitrum.io/rpc',
        symbol: 'ETH',
        blockExplorer: 'https://arbiscan.io'
      },
      'optimism': {
        name: 'Optimism',
        chainId: '0xa',
        chainIdInt: 10,
        rpcUrl: 'https://mainnet.optimism.io',
        symbol: 'ETH',
        blockExplorer: 'https://optimistic.etherscan.io'
      },
      'base': {
        name: 'Base',
        chainId: '0x2105',
        chainIdInt: 8453,
        rpcUrl: 'https://mainnet.base.org',
        symbol: 'ETH',
        blockExplorer: 'https://basescan.org'
      },
      'bsc': {
        name: 'å¹£å®‰æ™ºèƒ½éˆ',
        chainId: '0x38',
        chainIdInt: 56,
        rpcUrl: 'https://bsc-dataseed.binance.org',
        symbol: 'BNB',
        blockExplorer: 'https://bscscan.com'
      },
      'avalanche': {
        name: 'Avalanche C-Chain',
        chainId: '0xa86a',
        chainIdInt: 43114,
        rpcUrl: 'https://api.avax.network/ext/bc/C/rpc',
        symbol: 'AVAX',
        blockExplorer: 'https://snowtrace.io'
      },
      'fantom': {
        name: 'Fantom',
        chainId: '0xfa',
        chainIdInt: 250,
        rpcUrl: 'https://rpc.ftm.tools',
        symbol: 'FTM',
        blockExplorer: 'https://ftmscan.com'
      }
    };

    // ç²å–é¸ä¸­çš„ç¶²çµ¡
    function getSelectedNetwork() {
      const networkId = document.getElementById('network').value;
      return networkConfig[networkId];
    }

    // åˆ‡æ›ç¶²çµ¡
    async function switchNetwork(ethereum, chainId) {
      try {
        await ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: chainId }],
        });
      } catch (switchError) {
        // å¦‚æœç¶²çµ¡ä¸å­˜åœ¨ï¼Œå‰‡æ·»åŠ ç¶²çµ¡
        if (switchError.code === 4902) {
          const network = getSelectedNetwork();
          try {
            await ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: network.chainId,
                chainName: network.name,
                rpcUrls: [network.rpcUrl],
                nativeCurrency: {
                  name: network.symbol,
                  symbol: network.symbol,
                  decimals: 18,
                },
                blockExplorerUrls: [network.blockExplorer],
              }],
            });
          } catch (addError) {
            throw new Error('æ·»åŠ ç¶²çµ¡å¤±æ•—ï¼š' + addError.message);
          }
        } else {
          throw switchError;
        }
      }
    }

    // é€šç”¨ EVM ç°½åå‡½æ•¸
    async function signWithEVM(providerName, getProvider) {
      const btn = document.getElementById(`btn${providerName}`);
      const textSpan = document.getElementById(`${providerName.charAt(0).toLowerCase() + providerName.slice(1)}Text`);
      const result = document.getElementById('result');
      const walletInfo = document.getElementById('walletInfo');

      try {
        btn.disabled = true;
        textSpan.innerHTML = '<span class="loading"></span>é€£æ¥ä¸­...';
        clearStatus();

        const ethereum = getProvider();
        if (!ethereum) {
          showStatus('error', `è«‹å…ˆå®‰è£ ${providerName} æ“´å……åŠŸèƒ½ï¼`);
          return;
        }

        const msg = document.getElementById('message').value.trim();
        if (!msg) {
          showStatus('error', 'è«‹å…ˆè¼¸å…¥è¦ç°½åçš„è¨Šæ¯ï¼');
          return;
        }

        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          throw new Error('æœªé¸æ“‡å¸³æˆ¶');
        }

        const from = accounts[0];

        // åˆ‡æ›åˆ°é¸å®šçš„ç¶²çµ¡
        const selectedNetwork = getSelectedNetwork();
        if (selectedNetwork) {
          textSpan.innerHTML = '<span class="loading"></span>åˆ‡æ›ç¶²çµ¡ä¸­...';
          await switchNetwork(ethereum, selectedNetwork.chainId);
        }

        walletInfo.innerHTML = `
          <div class="wallet-info">
            <strong>éŒ¢åŒ…ï¼š</strong><span>${providerName}</span>
            <strong>åœ°å€ï¼š</strong><span class="wallet-address">${from}</span>
            <strong>ç¶²çµ¡ï¼š</strong><span>${selectedNetwork ? selectedNetwork.name : 'æœªçŸ¥'}</span>
          </div>
        `;

        textSpan.innerHTML = '<span class="loading"></span>è«‹åœ¨ ' + providerName + ' ç¢ºèªç°½å...';
        const signature = await ethereum.request({
          method: 'personal_sign',
          params: [msg, from],
        });

        // å°‡è¨Šæ¯è½‰æ›ç‚ºåå…­é€²åˆ¶æ ¼å¼
        const msgHex = '0x' + Array.from(new TextEncoder().encode(msg))
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');

        const resultObj = {
          msg: msgHex,
          version: "1.0",
          signer: "wing9897",
          signature: signature,
          network: selectedNetwork ? selectedNetwork.name : 'æœªçŸ¥',
          chainId: selectedNetwork ? selectedNetwork.chainIdInt : null
        };

        result.textContent = `${providerName} ç°½åçµæœï¼š\n\n${JSON.stringify(resultObj, null, 2)}`;
        result.classList.remove('result-empty');
        document.getElementById('btnCopy').style.display = 'block';
        showStatus('success', 'ç°½åæˆåŠŸï¼');

      } catch (error) {
        const errorMsg = error.code === 4001 ? 'ç°½åå¤±æ•—ï¼šç”¨æˆ¶æ‹’çµ•äº†ç°½åè«‹æ±‚' :
                         `ç°½åå¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        result.textContent = errorMsg;
        result.classList.remove('result-empty');
        showStatus('error', errorMsg);
      } finally {
        btn.disabled = false;
        // æ¢å¾©æŒ‰éˆ•æ–‡å­—
        if (providerName === 'MetaMask') textSpan.textContent = 'ğŸ¦Š MetaMask';
        else if (providerName === 'Coinbase Wallet') textSpan.textContent = 'ğŸ’° Coinbase';
        else if (providerName === 'Trust Wallet') textSpan.textContent = 'ğŸ” Trust Wallet';
        else if (providerName === 'OKX Wallet') textSpan.textContent = 'ğŸª™ OKX Wallet';
      }
    }

    // å–å¾— MetaMask provider
    function getMetaMaskProvider() {
      if (typeof window.ethereum !== 'undefined') {
        if (window.ethereum.isMetaMask) return window.ethereum;
        if (window.ethereum.providers) {
          const mm = window.ethereum.providers.find(p => p?.isMetaMask);
          if (mm) return mm;
        }
        return window.ethereum;
      }
      return null;
    }

    // å–å¾— Coinbase Wallet provider
    function getCoinbaseProvider() {
      if (typeof window.ethereum !== 'undefined') {
        if (window.ethereum.isCoinbaseWallet) return window.ethereum;
        if (window.ethereum.providers) {
          const cb = window.ethereum.providers.find(p => p?.isCoinbaseWallet);
          if (cb) return cb;
        }
      }
      return null;
    }

    // å–å¾— Trust Wallet provider
    function getTrustProvider() {
      if (typeof window.ethereum !== 'undefined') {
        if (window.ethereum.isTrustWallet) return window.ethereum;
        if (window.ethereum.providers) {
          const tw = window.ethereum.providers.find(p => p?.isTrustWallet);
          if (tw) return tw;
        }
      }
      return null;
    }

    // å–å¾— OKX Wallet provider
    function getOKXProvider() {
      if (window.okx?.wallet?.ethereum) return window.okx.wallet.ethereum;
      if (window.okexchain) return window.okexchain;
      return null;
    }

    // MetaMask ç°½å
    async function signWithMetaMask() {
      await signWithEVM('MetaMask', getMetaMaskProvider);
    }

    // Coinbase Wallet ç°½å
    async function signWithCoinbase() {
      await signWithEVM('Coinbase Wallet', getCoinbaseProvider);
    }

    // Trust Wallet ç°½å
    async function signWithTrust() {
      await signWithEVM('Trust Wallet', getTrustProvider);
    }

    // OKX Wallet ç°½å
    async function signWithOKX() {
      await signWithEVM('OKX Wallet', getOKXProvider);
    }

    // å–å¾— Phantom provider
    function getPhantomProvider() {
      if ('solana' in window && window.solana?.isPhantom) return window.solana;
      if (window.phantom?.solana?.isPhantom) return window.phantom.solana;
      return null;
    }

    // å–å¾— Solflare provider
    function getSolflareProvider() {
      if (window.solflare?.isConnected || window.solflare) return window.solflare;
      return null;
    }


    // Base58 ç·¨ç¢¼å‡½æ•¸ï¼ˆç”¨æ–¼ Solana ç°½åï¼‰
    function base58encode(buffer) {
      const alphabet = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
      let digits = [0];
      for (let i = 0; i < buffer.length; ++i) {
        let carry = buffer[i];
        for (let j = 0; j < digits.length; ++j) {
          carry += digits[j] << 8;
          digits[j] = carry % 58;
          carry = (carry / 58) | 0;
        }
        while (carry) {
          digits.push(carry % 58);
          carry = (carry / 58) | 0;
        }
      }
      // è™•ç†å‰å°0
      let zeros = 0;
      while (zeros < buffer.length && buffer[zeros] === 0) ++zeros;
      let result = alphabet[0].repeat(zeros);
      for (let i = digits.length - 1; i >= 0; --i) result += alphabet[digits[i]];
      return result;
    }

    // Phantom ç°½å
    async function signWithPhantom() {
      const btn = document.getElementById('btnPhantom');
      const textSpan = document.getElementById('phantomText');
      const result = document.getElementById('result');
      const walletInfo = document.getElementById('walletInfo');

      try {
        btn.disabled = true;
        textSpan.innerHTML = '<span class="loading"></span>é€£æ¥ä¸­...';
        clearStatus();

        const solana = getPhantomProvider();
        if (!solana) {
          showStatus('error', 'è«‹å…ˆå®‰è£ Phantom æ“´å……åŠŸèƒ½ï¼');
          return;
        }

        const msg = document.getElementById('message').value.trim();
        if (!msg) {
          showStatus('error', 'è«‹å…ˆè¼¸å…¥è¦ç°½åçš„è¨Šæ¯ï¼');
          return;
        }

        // é€£æ¥åˆ°éŒ¢åŒ…
        if (!solana.isConnected) {
          await solana.connect();
        }
        const publicKey = solana.publicKey?.toString() || solana.publicKey;

        walletInfo.innerHTML = `
          <div class="wallet-info">
            <strong>éŒ¢åŒ…ï¼š</strong><span>Phantom</span>
            <strong>åœ°å€ï¼š</strong><span class="wallet-address">${publicKey}</span>
          </div>
        `;

        textSpan.innerHTML = '<span class="loading"></span>è«‹åœ¨ Phantom ç¢ºèªç°½å...';

        // ä½¿ç”¨ request API é€²è¡Œç°½åï¼ˆæ›´æ–°çš„æ–¹æ³•ï¼‰
        const encodedMsg = new TextEncoder().encode(msg);
        const signed = await solana.request({
          method: "signMessage",
          params: { message: encodedMsg, display: "utf8" }
        });

        if (!signed?.signature) throw new Error('ç°½åè¿”å›æ ¼å¼ä¸æ­£ç¢º');

        // è™•ç†ç°½åæ ¼å¼ï¼ˆå¯èƒ½æ˜¯å­—ä¸²ã€Uint8Array æˆ–é™£åˆ—ï¼‰
        let signature = signed.signature;
        let base58Signature = "";

        if (typeof signature === "string") {
          // Phantom å¯èƒ½ç›´æ¥çµ¦ base58 å­—ä¸²
          base58Signature = signature;
        } else if (signature instanceof Uint8Array) {
          base58Signature = base58encode(signature);
        } else if (Array.isArray(signature)) {
          base58Signature = base58encode(Uint8Array.from(signature));
        } else {
          throw new Error('ç°½åå‹åˆ¥æœªçŸ¥');
        }

        // ç”Ÿæˆå…¶ä»–æ ¼å¼
        const hex = '0x' + Array.from(new Uint8Array(signature instanceof Uint8Array ? signature : new Uint8Array(signature)),
                                       b => b.toString(16).padStart(2, '0')).join('');
        const pubKey = signed.publicKey?.toString() || publicKey;

        result.textContent = `Phantom ç°½åçµæœï¼š\n\nè¨Šæ¯ï¼š${msg}\n\nBase58ï¼ˆç”¨æ–¼ OSLï¼‰ï¼š\n${base58Signature}\n\nHexï¼š\n${hex}\n\nå…¬é‘°ï¼š\n${pubKey}`;
        result.classList.remove('result-empty');
        document.getElementById('btnCopy').style.display = 'block';
        showStatus('success', 'ç°½åæˆåŠŸï¼');

      } catch (error) {
        const errorMsg = (error.code === 4001 || error.message?.includes('rejected') || error.message?.includes('cancelled'))
                        ? 'ç°½åå¤±æ•—ï¼šç”¨æˆ¶æ‹’çµ•äº†ç°½åè«‹æ±‚'
                        : `ç°½åå¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        result.textContent = errorMsg;
        result.classList.remove('result-empty');
        showStatus('error', errorMsg);
      } finally {
        btn.disabled = false;
        textSpan.textContent = 'ğŸ‘» Phantom';
      }
    }

    // Solflare ç°½å
    async function signWithSolflare() {
      const btn = document.getElementById('btnSolflare');
      const textSpan = document.getElementById('solflareText');
      const result = document.getElementById('result');
      const walletInfo = document.getElementById('walletInfo');

      try {
        btn.disabled = true;
        textSpan.innerHTML = '<span class="loading"></span>é€£æ¥ä¸­...';
        clearStatus();

        const solflare = getSolflareProvider();
        if (!solflare) {
          showStatus('error', 'è«‹å…ˆå®‰è£ Solflare æ“´å……åŠŸèƒ½ï¼');
          return;
        }

        const msg = document.getElementById('message').value.trim();
        if (!msg) {
          showStatus('error', 'è«‹å…ˆè¼¸å…¥è¦ç°½åçš„è¨Šæ¯ï¼');
          return;
        }

        // é€£æ¥åˆ°éŒ¢åŒ…
        if (!solflare.isConnected) {
          await solflare.connect();
        }
        const publicKey = solflare.publicKey?.toString() || solflare.publicKey;

        walletInfo.innerHTML = `
          <div class="wallet-info">
            <strong>éŒ¢åŒ…ï¼š</strong><span>Solflare</span>
            <strong>åœ°å€ï¼š</strong><span class="wallet-address">${publicKey}</span>
          </div>
        `;

        textSpan.innerHTML = '<span class="loading"></span>è«‹åœ¨ Solflare ç¢ºèªç°½å...';

        // ä½¿ç”¨ signMessage é€²è¡Œç°½å
        const encodedMsg = new TextEncoder().encode(msg);
        const signed = await solflare.signMessage(encodedMsg, 'utf8');

        if (!signed?.signature) throw new Error('ç°½åè¿”å›æ ¼å¼ä¸æ­£ç¢º');

        // è™•ç†ç°½åæ ¼å¼
        let signature = signed.signature;
        let base58Signature = "";

        if (typeof signature === "string") {
          base58Signature = signature;
        } else if (signature instanceof Uint8Array) {
          base58Signature = base58encode(signature);
        } else if (Array.isArray(signature)) {
          base58Signature = base58encode(Uint8Array.from(signature));
        } else {
          throw new Error('ç°½åå‹åˆ¥æœªçŸ¥');
        }

        // ç”Ÿæˆå…¶ä»–æ ¼å¼
        const hex = '0x' + Array.from(new Uint8Array(signature instanceof Uint8Array ? signature : new Uint8Array(signature)),
                                       b => b.toString(16).padStart(2, '0')).join('');
        const pubKey = signed.publicKey?.toString() || publicKey;

        result.textContent = `Solflare ç°½åçµæœï¼š\n\nè¨Šæ¯ï¼š${msg}\n\nBase58ï¼ˆç”¨æ–¼ OSLï¼‰ï¼š\n${base58Signature}\n\nHexï¼š\n${hex}\n\nå…¬é‘°ï¼š\n${pubKey}`;
        result.classList.remove('result-empty');
        document.getElementById('btnCopy').style.display = 'block';
        showStatus('success', 'ç°½åæˆåŠŸï¼');

      } catch (error) {
        const errorMsg = (error.code === 4001 || error.message?.includes('rejected') || error.message?.includes('cancelled'))
                        ? 'ç°½åå¤±æ•—ï¼šç”¨æˆ¶æ‹’çµ•äº†ç°½åè«‹æ±‚'
                        : `ç°½åå¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        result.textContent = errorMsg;
        result.classList.remove('result-empty');
        showStatus('error', errorMsg);
      } finally {
        btn.disabled = false;
        textSpan.textContent = 'â˜€ï¸ Solflare';
      }
    }

    // è¤‡è£½çµæœ
    async function copyResult() {
      const text = document.getElementById('result').textContent;
      try {
        await navigator.clipboard.writeText(text);
        showStatus('success', 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        setTimeout(clearStatus, 2000);
      } catch (error) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showStatus('success', 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
          setTimeout(clearStatus, 2000);
        } catch {
          showStatus('error', 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
        }
        document.body.removeChild(textArea);
      }
    }

    function showStatus(type, message) {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
    }

    function clearStatus() {
      document.getElementById('status').className = 'status';
      document.getElementById('status').textContent = '';
    }

    // æ›´æ–°éŒ¢åŒ…ç‹€æ…‹
    function updateWalletStatus() {
      const mmEl = document.getElementById('metaMaskStatus');
      const cbEl = document.getElementById('coinbaseStatus');
      const twEl = document.getElementById('trustStatus');
      const okxEl = document.getElementById('okxStatus');
      const phEl = document.getElementById('phantomStatus');
      const sfEl = document.getElementById('solflareStatus');

      const updateStatusElement = (el, provider, name) => {
        if (provider) {
          el.innerHTML = 'âœ… ' + name + ' å·²æª¢æ¸¬åˆ°';
          el.style.color = '#28a745';
        } else {
          el.innerHTML = 'âŒ ' + name + ' æœªæª¢æ¸¬åˆ°';
          el.style.color = '#dc3545';
        }
      };

      updateStatusElement(mmEl, getMetaMaskProvider(), 'MetaMask');
      updateStatusElement(cbEl, getCoinbaseProvider(), 'Coinbase Wallet');
      updateStatusElement(twEl, getTrustProvider(), 'Trust Wallet');
      updateStatusElement(okxEl, getOKXProvider(), 'OKX Wallet');
      updateStatusElement(phEl, getPhantomProvider(), 'Phantom');
      updateStatusElement(sfEl, getSolflareProvider(), 'Solflare');
    }

    window.addEventListener('load', updateWalletStatus);

    // ç›£è½ MetaMask äº‹ä»¶
    const eth = getMetaMaskProvider();
    if (eth) {
      eth.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          showStatus('info', 'MetaMask å¸³æˆ¶å·²æ–·é–‹é€£æ¥');
          document.getElementById('walletInfo').innerHTML = '';
        }
      });
      eth.on('chainChanged', () => showStatus('info', 'ç¶²çµ¡å·²åˆ‡æ›ï¼Œè«‹é‡æ–°ç°½å'));
    }
  </script>
</body>
</html>

