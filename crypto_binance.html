<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è²¨å¹£æ•¸æ“šçˆ¬å–å™¨ - Binance API</title>

    <!-- SEO å…ƒæ•¸æ“š -->
    <meta name="description" content="å°ˆæ¥­ç´šåŠ å¯†è²¨å¹£æ•¸æ“šä¸‹è¼‰å·¥å…·ï¼Œé€šéBinance APIç²å–å¯¦æ™‚å¸‚å ´æ•¸æ“š">
    <meta name="keywords" content="åŠ å¯†è²¨å¹£,Binance,æ¯”ç‰¹å¹£,æ•¸æ“šä¸‹è¼‰,CSV,Excel,SQLite">
    <meta name="author" content="Crypto Data Crawler">

    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#F0B90B">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â‚¿</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SQL.js for SQLite database generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --primary-color: #F0B90B;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --dark-bg: #121212;
            --dark-card-bg: #1e1e1e;
            --dark-input-bg: #2a2a2a;
            --dark-border: #333;
            --text-light: #ffffff;
            --text-dark: #212529;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Theme */
        body[data-bs-theme="light"] {
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        [data-bs-theme="light"] .navbar {
            background: linear-gradient(135deg, #F0B90B, #d9a007);
        }

        [data-bs-theme="light"] .card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
        }
        
        [data-bs-theme="light"] .bg-light {
            background-color: #f8f9fa !important;
        }

        [data-bs-theme="light"] .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        /* Dark Theme */
        body[data-bs-theme="dark"] {
            background-color: var(--dark-bg);
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .navbar {
            background: linear-gradient(135deg, #1a1a1a, #000000);
            border-bottom: 1px solid var(--dark-border);
        }

        [data-bs-theme="dark"] .navbar .navbar-brand,
        [data-bs-theme="dark"] .navbar .nav-link,
        [data-bs-theme="dark"] .navbar .btn {
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .card {
            background-color: var(--dark-card-bg);
            border: 1px solid var(--dark-border);
        }
        
        [data-bs-theme="dark"] .bg-light {
            background-color: var(--dark-input-bg) !important;
        }

        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background-color: var(--dark-input-bg);
            border-color: #444;
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .table {
            --bs-table-bg: var(--dark-card-bg);
            --bs-table-striped-bg: var(--dark-input-bg);
            --bs-table-color: var(--text-light);
            --bs-table-border-color: var(--dark-border);
        }

        [data-bs-theme="dark"] .log-container {
            background-color: #000000;
            border: 1px solid var(--dark-border);
        }

        .log-container {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .status-success { color: var(--success-color); }
        .status-error { color: var(--danger-color); }
    </style>
</head>
<body data-bs-theme="light">
    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container">
            <span class="navbar-brand">â‚¿ åŠ å¯†è²¨å¹£æ•¸æ“šçˆ¬å–å™¨ - Binance</span>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light" onclick="setTheme('dark')" id="theme-btn">ğŸŒ™ æ·±è‰²</button>
                <button class="btn btn-outline-light ms-2" id="refresh-btn" type="button">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>
    </nav>

    <main class="container pb-5">
        <!-- éŒ¯èª¤æç¤ºå€åŸŸ -->
        <div id="error-alert" class="alert alert-danger d-none" role="alert">
            <ul id="error-list" class="mb-0"></ul>
        </div>

        <!-- æˆåŠŸæç¤ºå€åŸŸ -->
        <div id="success-alert" class="alert alert-success d-none" role="alert">
            <span id="success-message"></span>
        </div>

        <!-- ä¸»è¦è¨­å®šå¡ç‰‡ -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="h4 mb-4">â‚¿ Binance åŠ å¯†è²¨å¹£æ•¸æ“šè¨­ç½®</h2>
                
                <form id="download-form" class="row g-4">
                    <!-- äº¤æ˜“å°è¨­ç½® -->
                    <div class="col-12">
                        <div class="card border-0 bg-light">
                            <div class="card-header" style="background-color: #F0B90B; color: white;">
                                <h6 class="mb-0">â‚¿ äº¤æ˜“å°è¨­ç½®</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="symbols" class="form-label">äº¤æ˜“å°ä»£è™Ÿ</label>
                                        <textarea class="form-control" id="symbols" name="symbols" rows="3" required 
                                            placeholder="è¼¸å…¥Binanceäº¤æ˜“å°ï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”&#10;ä¾‹å¦‚: BTCUSDT, ETHUSDT, BNBUSDT">BTCUSDT, ETHUSDT, BNBUSDT</textarea>
                                        <div id="validation-status" class="mt-2">
                                            <span class="badge bg-success">âœ… æº–å‚™è¼¸å…¥äº¤æ˜“å°</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="interval" class="form-label">æ™‚é–“é–“éš”</label>
                                        <select class="form-select" id="interval" name="interval">
                                            <option value="1m">1åˆ†é˜</option>
                                            <option value="3m">3åˆ†é˜</option>
                                            <option value="5m">5åˆ†é˜</option>
                                            <option value="15m">15åˆ†é˜</option>
                                            <option value="30m">30åˆ†é˜</option>
                                            <option value="1h">1å°æ™‚</option>
                                            <option value="2h">2å°æ™‚</option>
                                            <option value="4h">4å°æ™‚</option>
                                            <option value="6h">6å°æ™‚</option>
                                            <option value="8h">8å°æ™‚</option>
                                            <option value="12h">12å°æ™‚</option>
                                            <option value="1d" selected>1å¤©</option>
                                            <option value="3d">3å¤©</option>
                                            <option value="1w">1é€±</option>
                                            <option value="1M">1æœˆ</option>
                                        </select>
                                        <div class="form-text mt-2">
                                            å¸¸è¦‹äº¤æ˜“å°ï¼š<br>
                                            â€¢ BTCUSDT (æ¯”ç‰¹å¹£)<br>
                                            â€¢ ETHUSDT (ä»¥å¤ªåŠ)<br>
                                            â€¢ BNBUSDT (å¹£å®‰å¹£)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥æœŸç¯„åœå’Œè¼¸å‡ºè¨­ç½® -->
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">ğŸ“… æ—¥æœŸç¯„åœ</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="start_date" class="form-label">é–‹å§‹</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                                    </div>
                                    <div class="col-6">
                                        <label for="end_date" class="form-label">çµæŸ</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date" required>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Binanceæ”¯æŒç²å–æ­·å²æ•¸æ“šï¼ˆæœ€å¤š1000æ¢è¨˜éŒ„/è«‹æ±‚ï¼‰</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">ğŸ’¾ è¼¸å‡ºè¨­ç½®</h6>
                            </div>
                            <div class="card-body">
                                <label class="form-label">æ ¼å¼</label>
                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="output_format" id="format-CSV" value="CSV" checked>
                                    <label class="btn btn-outline-primary" for="format-CSV">CSV</label>
                                    <input type="radio" class="btn-check" name="output_format" id="format-Excel" value="Excel">
                                    <label class="btn btn-outline-primary" for="format-Excel">Excel</label>
                                    <input type="radio" class="btn-check" name="output_format" id="format-SQLite" value="SQLite">
                                    <label class="btn btn-outline-primary" for="format-SQLite">SQLite</label>
                                    <input type="radio" class="btn-check" name="output_format" id="format-JSON" value="JSON">
                                    <label class="btn btn-outline-primary" for="format-JSON">JSON</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰éˆ• -->
                    <div class="col-12">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-secondary" type="button" id="clear-btn">ğŸ§¹ æ¸…ç©º</button>
                            <button class="btn btn-primary px-4" type="submit" id="download-btn" style="background-color: #F0B90B; border-color: #F0B90B;">
                                <span class="spinner-border spinner-border-sm d-none me-2" id="loading-spinner"></span>
                                ğŸš€ é–‹å§‹ä¸‹è¼‰
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- é€²åº¦é¡¯ç¤ºå€åŸŸ -->
        <div class="card shadow-sm mb-4 d-none" id="progress-card">
            <div class="card-body">
                <h5 class="card-title">ğŸ“Š ä¸‹è¼‰é€²åº¦</h5>
                <div class="progress mb-3">
                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%; background-color: #F0B90B;"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="progress-text">æº–å‚™ä¸­...</span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
        </div>

        <!-- æ—¥èªŒé¡¯ç¤ºå€åŸŸ -->
        <div class="card shadow-sm mb-4 d-none" id="log-card">
            <div class="card-body">
                <h5 class="card-title">ğŸ“ ä¸‹è¼‰æ—¥èªŒ</h5>
                <div class="log-container p-3" id="log-container">
                    <div id="log-content"></div>
                </div>
                <button class="btn btn-outline-secondary btn-sm mt-2" id="clear-log-btn">æ¸…ç©ºæ—¥èªŒ</button>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
        <div class="card shadow-sm d-none" id="results-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">ğŸ“ˆ ä¸‹è¼‰çµæœ</h5>
                    <button class="btn btn-success" id="download-all-btn">ğŸ’¾ ä¸‹è¼‰å…¨éƒ¨</button>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 status-success" id="success-count">0</div>
                            <small class="text-muted">æˆåŠŸ</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 status-error" id="failed-count">0</div>
                            <small class="text-muted">å¤±æ•—</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary" id="total-count">0</div>
                            <small class="text-muted">ç¸½è¨ˆ</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info" id="total-records">0</div>
                            <small class="text-muted">ç¸½è¨˜éŒ„æ•¸</small>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>äº¤æ˜“å°</th>
                                <th>ç‹€æ…‹</th>
                                <th>è¨˜éŒ„æ•¸</th>
                                <th>è¨Šæ¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>â‚¿ Binance åŠ å¯†è²¨å¹£æ•¸æ“šçˆ¬å–å™¨</h6>
                    <p class="text-muted small">é€šéBinanceå…¬å…±APIç²å–å¯¦æ™‚åŠ å¯†è²¨å¹£å¸‚å ´æ•¸æ“š</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="mb-2">
                        <span class="badge bg-warning text-dark">Binance API</span>
                        <span class="badge bg-info">ç´”å‰ç«¯</span>
                        <span class="badge bg-success">å³æ™‚æ•¸æ“š</span>
                    </div>
                    <p class="text-muted small">Â© 2024 åƒ…ä¾›æ•™è‚²ä½¿ç”¨</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let downloadResults = [];
        let isDownloading = false;

        const elements = {
            form: document.getElementById('download-form'),
            symbolsInput: document.getElementById('symbols'),
            intervalSelect: document.getElementById('interval'),
            startDateInput: document.getElementById('start_date'),
            endDateInput: document.getElementById('end_date'),
            downloadBtn: document.getElementById('download-btn'),
            clearBtn: document.getElementById('clear-btn'),
            loadingSpinner: document.getElementById('loading-spinner'),
            errorAlert: document.getElementById('error-alert'),
            errorList: document.getElementById('error-list'),
            successAlert: document.getElementById('success-alert'),
            successMessage: document.getElementById('success-message'),
            progressCard: document.getElementById('progress-card'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            logCard: document.getElementById('log-card'),
            logContainer: document.getElementById('log-container'),
            logContent: document.getElementById('log-content'),
            clearLogBtn: document.getElementById('clear-log-btn'),
            resultsCard: document.getElementById('results-card'),
            resultsTbody: document.getElementById('results-tbody'),
            successCount: document.getElementById('success-count'),
            failedCount: document.getElementById('failed-count'),
            totalCount: document.getElementById('total-count'),
            totalRecords: document.getElementById('total-records'),
            downloadAllBtn: document.getElementById('download-all-btn')
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            setupEventListeners();
            loadTheme();
        });

        function initializeDates() {
            const today = new Date();
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(today.getMonth() - 1);
            elements.startDateInput.value = oneMonthAgo.toISOString().split('T')[0];
            elements.endDateInput.value = today.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            elements.form.addEventListener('submit', handleDownload);
            elements.clearBtn.addEventListener('click', clearForm);
            elements.clearLogBtn.addEventListener('click', clearLog);
            elements.downloadAllBtn.addEventListener('click', downloadAllResults);
            document.getElementById('refresh-btn').addEventListener('click', () => location.reload());
        }

        function setTheme(theme) {
            document.body.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            const btn = document.getElementById('theme-btn');
            btn.textContent = theme === 'dark' ? 'â˜€ï¸ æ·ºè‰²' : 'ğŸŒ™ æ·±è‰²';
            btn.onclick = () => setTheme(theme === 'dark' ? 'light' : 'dark');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function showError(messages) {
            elements.errorList.innerHTML = '';
            messages.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                elements.errorList.appendChild(li);
            });
            elements.errorAlert.classList.remove('d-none');
            elements.successAlert.classList.add('d-none');
        }

        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successAlert.classList.remove('d-none');
            elements.errorAlert.classList.add('d-none');
        }

        function hideAlerts() {
            elements.errorAlert.classList.add('d-none');
            elements.successAlert.classList.add('d-none');
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            
            if (type === 'error') logEntry.style.color = '#ff6b6b';
            else if (type === 'success') logEntry.style.color = '#51cf66';
            else if (type === 'warning') logEntry.style.color = '#ffd43b';
            
            elements.logContent.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
            elements.logCard.classList.remove('d-none');
        }

        function clearLog() {
            elements.logContent.innerHTML = '';
            elements.logCard.classList.add('d-none');
        }

        function updateProgress(current, total, message = '') {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${percent}%`;
            elements.progressText.textContent = message || `${current}/${total}`;
            elements.progressCard.classList.remove('d-none');
        }

        async function fetchBinanceData(symbol, interval, startDate, endDate) {
            try {
                const startTime = new Date(startDate).getTime();
                const endTime = new Date(endDate).getTime();
                
                const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}&limit=1000`;
                
                addLog(`ğŸ“¡ æ­£åœ¨å¾ Binance ç²å– ${symbol} æ•¸æ“š...`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const klines = await response.json();
                
                if (!klines || klines.length === 0) {
                    return {
                        success: false,
                        records: 0,
                        message: 'ç„¡æ•¸æ“šè¿”å›',
                        data: null
                    };
                }
                
                // è½‰æ›æ•¸æ“šæ ¼å¼
                const data = klines.map(k => ({
                    Symbol: symbol,
                    Time: new Date(k[0]).toISOString().replace('T', ' ').substring(0, 19),
                    Open: parseFloat(k[1]),
                    High: parseFloat(k[2]),
                    Low: parseFloat(k[3]),
                    Close: parseFloat(k[4]),
                    Volume: parseFloat(k[5])
                }));
                
                addLog(`âœ… æˆåŠŸç²å– ${symbol} ${data.length} ç­†æ•¸æ“š`, 'success');
                
                return {
                    success: true,
                    records: data.length,
                    message: `æˆåŠŸç²å– ${data.length} ç­†æ•¸æ“š`,
                    data: data
                };
                
            } catch (error) {
                addLog(`âŒ ${symbol} ç²å–å¤±æ•—: ${error.message}`, 'error');
                return {
                    success: false,
                    records: 0,
                    message: error.message,
                    data: null
                };
            }
        }

        async function handleDownload(event) {
            event.preventDefault();
            
            if (isDownloading) return;
            
            hideAlerts();
            isDownloading = true;
            downloadResults = [];
            
            elements.downloadBtn.disabled = true;
            elements.loadingSpinner.classList.remove('d-none');
            elements.resultsCard.classList.add('d-none');
            
            const formData = new FormData(elements.form);
            const symbolsText = formData.get('symbols');
            const symbols = symbolsText.split(/[,\n\r]+/).map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
            const interval = formData.get('interval');
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            const outputFormat = formData.get('output_format');
            
            addLog(`é–‹å§‹ä¸‹è¼‰ ${symbols.length} å€‹äº¤æ˜“å°çš„æ•¸æ“š`, 'info');
            addLog(`æ™‚é–“ç¯„åœ: ${startDate} è‡³ ${endDate}`, 'info');
            addLog(`æ™‚é–“é–“éš”: ${interval}, è¼¸å‡ºæ ¼å¼: ${outputFormat}`, 'info');
            
            let completed = 0;
            
            for (const symbol of symbols) {
                if (!isDownloading) break;
                
                updateProgress(completed, symbols.length, `æ­£åœ¨ä¸‹è¼‰ ${symbol}...`);
                
                const result = await fetchBinanceData(symbol, interval, startDate, endDate);
                result.symbol = symbol;
                result.outputFormat = outputFormat;
                downloadResults.push(result);
                
                completed++;
                updateProgress(completed, symbols.length);
                
                // å»¶é²é¿å…é€Ÿç‡é™åˆ¶
                if (completed < symbols.length && isDownloading) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            isDownloading = false;
            elements.downloadBtn.disabled = false;
            elements.loadingSpinner.classList.add('d-none');
            
            const successCount = downloadResults.filter(r => r.success).length;
            const failedCount = downloadResults.length - successCount;
            const totalRecords = downloadResults.reduce((sum, r) => sum + r.records, 0);
            
            addLog(`ä¸‹è¼‰å®Œæˆ! æˆåŠŸ: ${successCount}, å¤±æ•—: ${failedCount}, ç¸½è¨˜éŒ„æ•¸: ${totalRecords}`, 'success');
            showSuccess(`ä¸‹è¼‰å®Œæˆ! æˆåŠŸ: ${successCount} å€‹, å¤±æ•—: ${failedCount} å€‹`);
            displayResults();
        }

        function displayResults() {
            if (downloadResults.length === 0) return;
            
            const successCount = downloadResults.filter(r => r.success).length;
            const failedCount = downloadResults.length - successCount;
            const totalRecords = downloadResults.reduce((sum, r) => sum + r.records, 0);
            
            elements.successCount.textContent = successCount;
            elements.failedCount.textContent = failedCount;
            elements.totalCount.textContent = downloadResults.length;
            elements.totalRecords.textContent = totalRecords.toLocaleString();
            
            elements.resultsTbody.innerHTML = '';
            
            downloadResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${result.symbol}</strong></td>
                    <td>
                        <span class="badge ${result.success ? 'text-bg-success' : 'text-bg-danger'}">
                            ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}
                        </span>
                    </td>
                    <td>${result.records.toLocaleString()}</td>
                    <td>${result.message}</td>
                    <td>
                        ${result.success ? 
                            `<button class="btn btn-sm btn-outline-primary" onclick="downloadSingle(${index})">ğŸ’¾ ä¸‹è¼‰</button>` :
                            `<span class="text-muted">-</span>`
                        }
                    </td>
                `;
                elements.resultsTbody.appendChild(row);
            });
            
            elements.resultsCard.classList.remove('d-none');
        }

        async function downloadSingle(index) {
            const result = downloadResults[index];
            if (!result.success || !result.data) return;
            
            const filename = `${result.symbol}_binance_${result.outputFormat.toLowerCase()}`;
            await downloadData(result.data, filename, result.outputFormat);
        }

        async function downloadAllResults() {
            const successResults = downloadResults.filter(r => r.success);
            if (successResults.length === 0) {
                showError(['æ²’æœ‰æˆåŠŸçš„ä¸‹è¼‰çµæœ']);
                return;
            }
            
            for (let i = 0; i < successResults.length; i++) {
                const result = successResults[i];
                const filename = `${result.symbol}_binance`;
                await downloadData(result.data, filename, result.outputFormat);
                if (i < successResults.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            showSuccess(`å·²å®Œæˆä¸‹è¼‰ ${successResults.length} å€‹æ–‡ä»¶`);
        }

        async function downloadData(data, filename, format) {
            let content, mimeType, extension;
            
            switch (format) {
                case 'CSV':
                    content = convertToCSV(data);
                    mimeType = 'text/csv;charset=utf-8';
                    extension = 'csv';
                    break;
                case 'JSON':
                    content = JSON.stringify(data, null, 2);
                    mimeType = 'application/json;charset=utf-8';
                    extension = 'json';
                    break;
                case 'SQLite':
                    content = await convertToSQLite(data, filename);
                    mimeType = 'application/x-sqlite3';
                    extension = 'db';
                    break;
                default:
                    content = convertToCSV(data);
                    mimeType = 'text/csv;charset=utf-8';
                    extension = 'csv';
            }
            
            let blob;
            if (content instanceof Uint8Array) {
                blob = new Blob([content], { type: mimeType });
            } else {
                const BOM = '\uFEFF';
                blob = new Blob([BOM + content], { type: mimeType });
            }
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            return csvContent;
        }

        async function convertToSQLite(data, tableName) {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                const db = new SQL.Database();
                const safeName = tableName.replace(/[^a-zA-Z0-9_]/g, '_');
                
                db.run(`
                    CREATE TABLE crypto_${safeName} (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        symbol TEXT NOT NULL,
                        time TEXT NOT NULL,
                        open REAL NOT NULL,
                        high REAL NOT NULL,
                        low REAL NOT NULL,
                        close REAL NOT NULL,
                        volume REAL NOT NULL
                    )
                `);
                
                const stmt = db.prepare(`
                    INSERT INTO crypto_${safeName} (symbol, time, open, high, low, close, volume)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                `);
                
                db.exec('BEGIN TRANSACTION');
                data.forEach(row => {
                    stmt.run([row.Symbol, row.Time, row.Open, row.High, row.Low, row.Close, row.Volume]);
                });
                db.exec('COMMIT');
                
                stmt.free();
                const binaryArray = db.export();
                db.close();
                
                return binaryArray;
            } catch (error) {
                console.error('SQLiteç”Ÿæˆå¤±æ•—:', error);
                throw error;
            }
        }

        function clearForm() {
            elements.symbolsInput.value = 'BTCUSDT, ETHUSDT, BNBUSDT';
            elements.intervalSelect.value = '1d';
            initializeDates();
            elements.progressCard.classList.add('d-none');
            elements.resultsCard.classList.add('d-none');
            hideAlerts();
            clearLog();
            downloadResults = [];
        }

        window.downloadSingle = downloadSingle;
    </script>
</body>
</html>
