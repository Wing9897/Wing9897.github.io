<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖像處理工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .sidebar {
            background: #f8fafc;
            padding: 20px;
            border-right: 1px solid #e2e8f0;
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-section h3 {
            color: #374151;
            font-size: 1rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin: 5px 0;
            width: 100%;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .btn.active:hover {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4), 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .canvas-container {
            position: relative;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 600px;
        }

        #canvas {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
        }

        .drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            pointer-events: none;
            z-index: 1;
        }

        .drop-zone.active {
            color: #3b82f6;
            font-weight: bold;
        }

        .status-bar {
            background: #f8fafc;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #64748b;
        }

        .status-info {
            display: flex;
            gap: 20px;
        }

        .loading {
            display: none;
            color: #3b82f6;
            font-weight: 500;
        }

        .loading.show {
            display: inline;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tool-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .tool-btn.active:hover {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4), 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .brush-sizes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .brush-size {
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .brush-size.active {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1d4ed8;
        }

        .export-options {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .export-options h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .size-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .size-inputs input {
            padding: 6px 8px;
            font-size: 0.8rem;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .export-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .export-btn.svg {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .export-btn.png {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .export-btn.jpg {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .tool-tips {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: #065f46;
        }

        .tool-tips h4 {
            margin-bottom: 8px;
            color: #047857;
        }

        .tool-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .tool-tips li {
            margin-bottom: 4px;
            padding-left: 15px;
            position: relative;
        }

        .tool-tips li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #10b981;
        }

        .bg-method-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .color-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .color-picker-modal.show {
            display: flex;
        }

        .color-picker-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .color-picker-content h3 {
            margin-bottom: 15px;
            color: #374151;
        }

        .color-picker-content input[type="color"] {
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .color-picker-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .api-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: #92400e;
        }

        .api-info h4 {
            margin-bottom: 8px;
            color: #92400e;
        }

        .api-info ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 10px;
        }

        .api-info li {
            margin-bottom: 4px;
            padding-left: 15px;
            position: relative;
        }

        .api-info li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #f59e0b;
        }

        .api-info a {
            color: #d97706;
            text-decoration: none;
        }

        .api-info a:hover {
            text-decoration: underline;
        }

        .unit-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .preset-sizes {
            margin-bottom: 15px;
        }

        .preset-sizes label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .preset-btn {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .preset-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .export-btn.webp {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .export-btn.pdf {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .settings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .settings-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .settings-info {
            text-align: center;
            color: #6b7280;
            font-size: 0.75rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 圖像處理工具</h1>
            <p>複製貼上 • 繪製 • 去背景 • 匯出多格式</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="tool-tips">
                    <h4>💡 使用提示</h4>
                    <ul>
                        <li>按 Ctrl+V 貼上圖像</li>
                        <li>拖拽圖像到畫布</li>
                        <li>點擊畫布開始繪製</li>
                        <li>選擇工具和顏色</li>
                    </ul>
                </div>

                <div class="api-info" id="apiInfo" style="display: none;">
                    <h4>🤖 AI 去背景服務</h4>
                    <ul>
                        <li><strong>Remove.bg:</strong> 專業去背景，每月免費額度</li>
                        <li><strong>ClipDrop:</strong> 高品質 AI 處理</li>
                        <li><strong>Replicate:</strong> 開源模型，靈活配置</li>
                    </ul>
                    <p>需要 API Key？<a href="#" onclick="showApiHelp()">查看說明</a></p>
                </div>

                <div class="tool-section">
                    <h3>📋 圖像操作</h3>
                    <button class="btn" onclick="pasteImage()">貼上圖像 (Ctrl+V)</button>
                    <button class="btn btn-secondary" onclick="clearCanvas()">清除畫布</button>
                    <div class="input-group">
                        <label>去背景方法</label>
                        <select id="bgMethod" class="bg-method-select">
                            <option value="simple">簡單移除 (白色背景)</option>
                            <option value="advanced">進階移除 (智能檢測)</option>
                            <option value="manual">手動選擇顏色</option>
                            <option value="remove-bg">Remove.bg AI</option>
                            <option value="clipdrop">ClipDrop AI</option>
                            <option value="replicate">Replicate AI</option>
                        </select>
                    </div>
                    <div class="input-group" id="apiKeyGroup" style="display: none;">
                        <label>API Key</label>
                        <input type="password" id="apiKey" placeholder="輸入您的 API Key">
                    </div>
                    <button class="btn btn-danger" onclick="removeBackground()">去背景</button>
                </div>

                <div class="tool-section">
                    <h3>🎨 繪製工具</h3>
                    <div class="input-group">
                        <label>工具選擇</label>
                        <div class="tool-buttons">
                            <button class="btn tool-btn active" data-tool="brush" onclick="selectTool('brush')">🖌️ 畫筆</button>
                            <button class="btn tool-btn" data-tool="eraser" onclick="selectTool('eraser')">🧽 橡皮擦</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>畫筆顏色</label>
                        <div class="color-picker">
                            <input type="color" id="brushColor" value="#000000">
                            <span id="colorValue">#000000</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>工具大小</label>
                        <div class="brush-sizes">
                            <div class="brush-size active" data-size="2">細</div>
                            <div class="brush-size" data-size="5">中</div>
                            <div class="brush-size" data-size="10">粗</div>
                        </div>
                    </div>

                    <button class="btn" id="drawingBtn" onclick="toggleDrawing()">開始繪製</button>
                </div>

                <div class="export-options">
                    <h4>📤 匯出設定</h4>
                    
                    <div class="input-group">
                        <label>尺寸單位</label>
                        <select id="exportUnit" class="unit-select">
                            <option value="px">像素 (px)</option>
                            <option value="cm">公分 (cm)</option>
                            <option value="mm">毫米 (mm)</option>
                            <option value="in">英吋 (in)</option>
                            <option value="pt">點 (pt)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>解析度 (DPI)</label>
                        <input type="number" id="exportDPI" value="300" min="72" max="600" step="1">
                    </div>
                    
                    <div class="size-inputs">
                        <div class="input-group">
                            <label>寬度</label>
                            <input type="number" id="exportWidth" value="800" min="1" max="10000" step="1">
                        </div>
                        <div class="input-group">
                            <label>高度</label>
                            <input type="number" id="exportHeight" value="600" min="1" max="10000" step="1">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>保持比例</label>
                        <input type="checkbox" id="keepAspectRatio" checked>
                    </div>
                    
                    <div class="preset-sizes">
                        <label>預設尺寸</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-width="1920" data-height="1080">HD</button>
                            <button class="preset-btn" data-width="2560" data-height="1440">2K</button>
                            <button class="preset-btn" data-width="3840" data-height="2160">4K</button>
                            <button class="preset-btn" data-width="800" data-height="600">網頁</button>
                            <button class="preset-btn" data-width="1080" data-height="1080">方形</button>
                            <button class="preset-btn" data-width="64" data-height="64">小圖示</button>
                            <button class="preset-btn" data-width="32" data-height="32">微圖示</button>
                            <button class="preset-btn" data-width="16" data-height="16">極小</button>
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn export-btn svg" onclick="exportImage('svg')">SVG</button>
                        <button class="btn export-btn png" onclick="exportImage('png')">PNG</button>
                        <button class="btn export-btn jpg" onclick="exportImage('jpg')">JPG</button>
                        <button class="btn export-btn webp" onclick="exportImage('webp')">WebP</button>
                        <button class="btn export-btn pdf" onclick="exportImage('pdf')">PDF</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>⚙️ 設定管理</h3>
                    <div class="settings-buttons">
                        <button class="btn btn-secondary" onclick="saveSettings('manual')">💾 儲存設定</button>
                        <button class="btn btn-secondary" onclick="loadSettings()">📂 載入設定</button>
                        <button class="btn btn-danger" onclick="resetSettings()">🔄 重置設定</button>
                    </div>
                    <div class="settings-info">
                        <small>✅ 自動儲存已啟用 - 設定會自動儲存到瀏覽器本地</small>
                        <br>
                        <small>🔄 每5分鐘自動備份 | 📝 變更後2秒自動儲存</small>
                    </div>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="canvas" width="800" height="600"></canvas>
                <div class="drop-zone" id="dropZone">
                    <h3>拖拽圖像到這裡</h3>
                    <p>或按 Ctrl+V 貼上圖像</p>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-info">
                <span id="canvasSize">畫布: 800 x 600</span>
                <span id="drawingStatus">繪製模式: 關閉</span>
            </div>
            <div class="loading" id="loading">處理中...</div>
        </div>
    </div>

    <!-- 顏色選擇器模態框 -->
    <div class="color-picker-modal" id="colorPickerModal">
        <div class="color-picker-content">
            <h3>選擇要移除的背景顏色</h3>
            <input type="color" id="bgColorPicker" value="#ffffff">
            <div class="color-picker-buttons">
                <button class="btn" onclick="confirmBgColor()">確認移除</button>
                <button class="btn btn-secondary" onclick="closeColorPicker()">取消</button>
            </div>
        </div>
    </div>

    <!-- API 說明模態框 -->
    <div class="color-picker-modal" id="apiHelpModal">
        <div class="color-picker-content" style="max-width: 500px;">
            <h3>🤖 AI 去背景 API 設定</h3>
            <div style="text-align: left; margin-bottom: 20px;">
                <h4>Remove.bg API</h4>
                <p>1. 前往 <a href="https://www.remove.bg/api" target="_blank">remove.bg/api</a></p>
                <p>2. 註冊帳號並獲取 API Key</p>
                <p>3. 每月有免費額度</p>
                
                <h4>ClipDrop API</h4>
                <p>1. 前往 <a href="https://clipdrop.co/api" target="_blank">clipdrop.co/api</a></p>
                <p>2. 註冊開發者帳號</p>
                <p>3. 獲取 API Key</p>
                
                <h4>Replicate API</h4>
                <p>1. 前往 <a href="https://replicate.com" target="_blank">replicate.com</a></p>
                <p>2. 註冊帳號並獲取 API Token</p>
                <p>3. 支援多種開源模型</p>
            </div>
            <button class="btn" onclick="closeApiHelp()">了解</button>
        </div>
    </div>

    <script>
        // 獲取畫布和上下文
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // 狀態變數
        let isDrawing = false;
        let isDrawingMode = false;
        let lastX = 0;
        let lastY = 0;
        let brushSize = 5;
        let brushColor = '#000000';
        let currentTool = 'brush';
        let hasImage = false;

        // 初始化
        function init() {
            setupEventListeners();
            updateStatus();
            setupColorPicker();
            setupBrushSizes();
        }

        // 設置事件監聽器
        function setupEventListeners() {
            // 鍵盤事件
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'v') {
                    e.preventDefault();
                    pasteImage();
                }
            });

            // 畫布事件
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // 拖拽事件
            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);

            // 點擊畫布區域
            document.querySelector('.canvas-container').addEventListener('click', () => {
                canvas.focus();
            });

            // 去背景方法選擇事件
            document.getElementById('bgMethod').addEventListener('change', updateApiKeyVisibility);
            
            // 匯出設定事件
            setupExportEvents();
            
            // 設定自動儲存
            setupAutoSave();
        }

        // 設置顏色選擇器
        function setupColorPicker() {
            const colorPicker = document.getElementById('brushColor');
            const colorValue = document.getElementById('colorValue');
            
            colorPicker.addEventListener('input', (e) => {
                brushColor = e.target.value;
                colorValue.textContent = brushColor;
                // 更新游標顏色
                if (isDrawingMode && currentTool === 'brush') {
                    updateCursor();
                }
            });
        }

        // 設置畫筆大小
        function setupBrushSizes() {
            const brushSizes = document.querySelectorAll('.brush-size');
            
            brushSizes.forEach(btn => {
                btn.addEventListener('click', () => {
                    brushSizes.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    brushSize = parseInt(btn.dataset.size);
                });
            });
        }

        // 開始繪製
        function startDrawing(e) {
            if (!isDrawingMode) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        // 繪製
        function draw(e) {
            if (!isDrawing || !isDrawingMode) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            
            if (currentTool === 'eraser') {
                ctx.strokeStyle = '#ffffff';
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.strokeStyle = brushColor;
                ctx.globalCompositeOperation = 'source-over';
            }
            
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.stroke();

            lastX = x;
            lastY = y;
        }

        // 停止繪製
        function stopDrawing() {
            isDrawing = false;
        }

        // 選擇工具
        function selectTool(tool) {
            currentTool = tool;
            
            // 更新工具按鈕狀態
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // 更新游標
            if (isDrawingMode) {
                updateCursor();
            }
        }

        // 切換繪製模式
        function toggleDrawing() {
            isDrawingMode = !isDrawingMode;
            updateStatus();
            updateCursor();
            updateDrawingButton();
        }

        // 更新游標
        function updateCursor() {
            if (isDrawingMode) {
                if (currentTool === 'eraser') {
                    // 橡皮擦游標
                    const eraserCursor = `url("data:image/svg+xml;base64,${btoa(`
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" fill="white" stroke="#666" stroke-width="2"/>
                            <path d="M8 8L16 16M16 8L8 16" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    `)}") 12 12, auto`;
                    canvas.style.cursor = eraserCursor;
                } else {
                    // 畫筆游標
                    const brushCursor = `url("data:image/svg+xml;base64,${btoa(`
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 21L12 12L21 3L18 0L9 9L0 18L3 21Z" fill="${brushColor}" stroke="#333" stroke-width="1"/>
                            <circle cx="12" cy="12" r="2" fill="${brushColor}"/>
                        </svg>
                    `)}") 12 12, auto`;
                    canvas.style.cursor = brushCursor;
                }
            } else {
                canvas.style.cursor = 'default';
            }
        }

        // 更新繪製按鈕
        function updateDrawingButton() {
            const btn = document.getElementById('drawingBtn');
            if (isDrawingMode) {
                btn.textContent = '停止繪製';
                btn.classList.add('active');
            } else {
                btn.textContent = '開始繪製';
                btn.classList.remove('active');
            }
        }

        // 貼上圖像
        async function pasteImage() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            loadImageFromBlob(blob);
                            return;
                        }
                    }
                }
                alert('剪貼簿中沒有找到圖像');
            } catch (error) {
                console.error('貼上失敗:', error);
                alert('貼上失敗，請確保剪貼簿中有圖像');
            }
        }

        // 從 Blob 載入圖像
        function loadImageFromBlob(blob) {
            const url = URL.createObjectURL(blob);
            const img = new Image();
            
            img.onload = () => {
                // 調整畫布大小以適應圖像
                const maxWidth = 800;
                const maxHeight = 600;
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // 繪製圖像
                ctx.clearRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);
                
                URL.revokeObjectURL(url);
                hasImage = true;
                updateStatus();
                updateDropZone();
            };
            
            img.src = url;
        }

        // 處理拖拽
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('active');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadImageFromBlob(files[0]);
            }
        }

        // 清除畫布
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // 去背景功能
        async function removeBackground() {
            const method = document.getElementById('bgMethod').value;
            
            if (method === 'manual') {
                showColorPicker();
                return;
            }
            
            if (['remove-bg', 'clipdrop', 'replicate'].includes(method)) {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    alert('請輸入 API Key');
                    return;
                }
                await removeBackgroundWithAI(method, apiKey);
                return;
            }
            
            showLoading(true);
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                if (method === 'simple') {
                    removeColorRange(data, [240, 240, 240], [255, 255, 255], 30);
                } else if (method === 'advanced') {
                    removeAdvancedBackground(data, canvas.width, canvas.height);
                }
                
                ctx.putImageData(imageData, 0, 0);
                alert('背景移除完成！');
            } catch (error) {
                console.error('去背景失敗:', error);
                alert('去背景失敗');
            } finally {
                showLoading(false);
            }
        }

        // 移除指定顏色範圍
        function removeColorRange(data, minColor, maxColor, tolerance) {
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 檢查是否在指定顏色範圍內
                if (r >= minColor[0] - tolerance && r <= maxColor[0] + tolerance &&
                    g >= minColor[1] - tolerance && g <= maxColor[1] + tolerance &&
                    b >= minColor[2] - tolerance && b <= maxColor[2] + tolerance) {
                    data[i + 3] = 0; // 設為透明
                }
            }
        }

        // 進階背景移除算法
        function removeAdvancedBackground(data, width, height) {
            // 邊緣檢測和顏色聚類
            const edges = detectEdges(data, width, height);
            const backgroundMask = createBackgroundMask(data, width, height);
            
            // 結合邊緣檢測和背景遮罩
            for (let i = 0; i < data.length; i += 4) {
                const pixelIndex = i / 4;
                const x = pixelIndex % width;
                const y = Math.floor(pixelIndex / width);
                
                if (backgroundMask[pixelIndex] && !edges[pixelIndex]) {
                    data[i + 3] = 0; // 設為透明
                }
            }
        }

        // 邊緣檢測
        function detectEdges(data, width, height) {
            const edges = new Array(data.length / 4).fill(false);
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // 計算梯度
                    const gx = Math.abs(data[idx + 4] - data[idx - 4]);
                    const gy = Math.abs(data[idx + width * 4] - data[idx - width * 4]);
                    const gradient = Math.sqrt(gx * gx + gy * gy);
                    
                    if (gradient > 30) {
                        edges[y * width + x] = true;
                    }
                }
            }
            
            return edges;
        }

        // 創建背景遮罩
        function createBackgroundMask(data, width, height) {
            const mask = new Array(data.length / 4).fill(false);
            const visited = new Array(data.length / 4).fill(false);
            
            // 從邊緣開始填充
            const queue = [];
            
            // 添加邊緣像素
            for (let x = 0; x < width; x++) {
                queue.push([x, 0]);
                queue.push([x, height - 1]);
            }
            for (let y = 0; y < height; y++) {
                queue.push([0, y]);
                queue.push([width - 1, y]);
            }
            
            // 洪水填充算法
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const idx = y * width + x;
                
                if (visited[idx]) continue;
                visited[idx] = true;
                
                const pixelIdx = idx * 4;
                const r = data[pixelIdx];
                const g = data[pixelIdx + 1];
                const b = data[pixelIdx + 2];
                
                // 檢查是否為背景色
                if (isBackgroundColor(r, g, b)) {
                    mask[idx] = true;
                    
                    // 添加相鄰像素
                    const neighbors = [
                        [x + 1, y], [x - 1, y],
                        [x, y + 1], [x, y - 1]
                    ];
                    
                    for (const [nx, ny] of neighbors) {
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            queue.push([nx, ny]);
                        }
                    }
                }
            }
            
            return mask;
        }

        // 判斷是否為背景色
        function isBackgroundColor(r, g, b) {
            // 檢查是否接近白色或淺色
            const brightness = (r + g + b) / 3;
            const saturation = Math.max(r, g, b) - Math.min(r, g, b);
            
            return brightness > 200 && saturation < 50;
        }

        // 顯示顏色選擇器
        function showColorPicker() {
            document.getElementById('colorPickerModal').classList.add('show');
        }

        // 關閉顏色選擇器
        function closeColorPicker() {
            document.getElementById('colorPickerModal').classList.remove('show');
        }

        // 確認背景顏色移除
        function confirmBgColor() {
            const color = document.getElementById('bgColorPicker').value;
            const rgb = hexToRgb(color);
            
            showLoading(true);
            
            setTimeout(() => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 移除指定顏色
                removeColorRange(data, [rgb.r - 30, rgb.g - 30, rgb.b - 30], 
                                       [rgb.r + 30, rgb.g + 30, rgb.b + 30], 30);
                
                ctx.putImageData(imageData, 0, 0);
                closeColorPicker();
                showLoading(false);
                alert('背景顏色移除完成！');
            }, 500);
        }

        // 十六進制轉RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // 更新 API Key 顯示
        function updateApiKeyVisibility() {
            const method = document.getElementById('bgMethod').value;
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const apiInfo = document.getElementById('apiInfo');
            
            if (['remove-bg', 'clipdrop', 'replicate'].includes(method)) {
                apiKeyGroup.style.display = 'block';
                apiInfo.style.display = 'block';
            } else {
                apiKeyGroup.style.display = 'none';
                apiInfo.style.display = 'none';
            }
        }

        // AI 去背景
        async function removeBackgroundWithAI(method, apiKey) {
            showLoading(true);
            
            try {
                const imageBlob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });
                
                let result;
                
                switch (method) {
                    case 'remove-bg':
                        result = await callRemoveBgAPI(imageBlob, apiKey);
                        break;
                    case 'clipdrop':
                        result = await callClipDropAPI(imageBlob, apiKey);
                        break;
                    case 'replicate':
                        result = await callReplicateAPI(imageBlob, apiKey);
                        break;
                }
                
                if (result) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        alert('AI 去背景完成！');
                    };
                    img.src = result;
                }
            } catch (error) {
                console.error('AI 去背景失敗:', error);
                alert('AI 去背景失敗: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Remove.bg API
        async function callRemoveBgAPI(imageBlob, apiKey) {
            const formData = new FormData();
            formData.append('image_file', imageBlob, 'image.png');
            
            const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: {
                    'X-Api-Key': apiKey
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Remove.bg API 錯誤: ${response.status}`);
            }
            
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        // ClipDrop API
        async function callClipDropAPI(imageBlob, apiKey) {
            const formData = new FormData();
            formData.append('image', imageBlob);
            
            const response = await fetch('https://clipdrop-api.co/remove-background/v1', {
                method: 'POST',
                headers: {
                    'x-api-key': apiKey
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`ClipDrop API 錯誤: ${response.status}`);
            }
            
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        // Replicate API
        async function callReplicateAPI(imageBlob, apiKey) {
            // 將圖像轉換為 base64
            const base64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(imageBlob);
            });
            
            const response = await fetch('https://api.replicate.com/v1/predictions', {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    version: "fb8af171cfa1616ddcf1242c093f9c46bcada5ad4cf6f2fbe8b81b330ec0c003",
                    input: {
                        image: `data:image/png;base64,${base64}`
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Replicate API 錯誤: ${response.status}`);
            }
            
            const prediction = await response.json();
            
            // 輪詢結果
            let result;
            for (let i = 0; i < 30; i++) {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const statusResponse = await fetch(prediction.urls.get, {
                    headers: {
                        'Authorization': `Token ${apiKey}`
                    }
                });
                
                const status = await statusResponse.json();
                
                if (status.status === 'succeeded') {
                    result = status.output;
                    break;
                } else if (status.status === 'failed') {
                    throw new Error('Replicate 處理失敗');
                }
            }
            
            if (!result) {
                throw new Error('Replicate 處理超時');
            }
            
            return result;
        }

        // 顯示 API 說明
        function showApiHelp() {
            document.getElementById('apiHelpModal').classList.add('show');
        }

        // 關閉 API 說明
        function closeApiHelp() {
            document.getElementById('apiHelpModal').classList.remove('show');
        }

        // 設定管理功能
        function saveSettings() {
            const settings = {
                // 繪製工具設定
                brushColor: brushColor,
                brushSize: brushSize,
                currentTool: currentTool,
                
                // 匯出設定
                exportUnit: document.getElementById('exportUnit').value,
                exportDPI: document.getElementById('exportDPI').value,
                exportWidth: document.getElementById('exportWidth').value,
                exportHeight: document.getElementById('exportHeight').value,
                keepAspectRatio: document.getElementById('keepAspectRatio').checked,
                
                // 去背景設定
                bgMethod: document.getElementById('bgMethod').value,
                apiKey: document.getElementById('apiKey').value,
                
                // 時間戳記
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('imageEditorSettings', JSON.stringify(settings));
                // 只在手動儲存時顯示通知
                if (arguments.length > 0 && arguments[0] === 'manual') {
                    showNotification('設定已儲存！', 'success');
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showNotification('儲存設定失敗', 'error');
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('imageEditorSettings');
            if (!saved) return;
            
            try {
                const settings = JSON.parse(saved);
                
                // 載入繪製工具設定
                if (settings.brushColor) {
                    brushColor = settings.brushColor;
                    document.getElementById('brushColor').value = brushColor;
                    document.getElementById('colorValue').textContent = brushColor;
                }
                
                if (settings.brushSize) {
                    brushSize = settings.brushSize;
                    document.querySelectorAll('.brush-size').forEach(btn => {
                        btn.classList.remove('active');
                        if (parseInt(btn.dataset.size) === brushSize) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                if (settings.currentTool) {
                    currentTool = settings.currentTool;
                    selectTool(currentTool);
                }
                
                // 載入匯出設定
                if (settings.exportUnit) {
                    document.getElementById('exportUnit').value = settings.exportUnit;
                }
                
                if (settings.exportDPI) {
                    document.getElementById('exportDPI').value = settings.exportDPI;
                }
                
                if (settings.exportWidth) {
                    document.getElementById('exportWidth').value = settings.exportWidth;
                }
                
                if (settings.exportHeight) {
                    document.getElementById('exportHeight').value = settings.exportHeight;
                }
                
                if (settings.keepAspectRatio !== undefined) {
                    document.getElementById('keepAspectRatio').checked = settings.keepAspectRatio;
                }
                
                // 載入去背景設定
                if (settings.bgMethod) {
                    document.getElementById('bgMethod').value = settings.bgMethod;
                    updateApiKeyVisibility();
                }
                
                if (settings.apiKey) {
                    document.getElementById('apiKey').value = settings.apiKey;
                }
                
                showNotification('設定已載入！', 'success');
                
            } catch (error) {
                console.error('載入設定失敗:', error);
                showNotification('載入設定失敗', 'error');
            }
        }

        function resetSettings() {
            if (confirm('確定要重置所有設定嗎？此操作無法復原。')) {
                localStorage.removeItem('imageEditorSettings');
                
                // 重置為預設值
                brushColor = '#000000';
                brushSize = 5;
                currentTool = 'brush';
                
                document.getElementById('brushColor').value = brushColor;
                document.getElementById('colorValue').textContent = brushColor;
                document.getElementById('exportUnit').value = 'px';
                document.getElementById('exportDPI').value = '300';
                document.getElementById('exportWidth').value = '800';
                document.getElementById('exportHeight').value = '600';
                document.getElementById('keepAspectRatio').checked = true;
                document.getElementById('bgMethod').value = 'simple';
                document.getElementById('apiKey').value = '';
                
                // 重置工具選擇
                selectTool('brush');
                updateApiKeyVisibility();
                
                showNotification('設定已重置！', 'success');
            }
        }

        // 顯示通知
        function showNotification(message, type = 'info') {
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-size: 0.9rem;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            document.body.appendChild(notification);
            
            // 3秒後自動移除
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 自動儲存設定
        function setupAutoSave() {
            let autoSaveTimer = null;
            
            // 自動儲存函數
            function triggerAutoSave() {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                }
                autoSaveTimer = setTimeout(() => {
                    saveSettings();
                    autoSaveTimer = null;
                }, 2000); // 延遲2秒自動儲存
            }
            
            // 監聽設定變更
            const settingsElements = [
                'brushColor', 'exportUnit', 'exportDPI', 'exportWidth', 
                'exportHeight', 'keepAspectRatio', 'bgMethod', 'apiKey'
            ];
            
            settingsElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', triggerAutoSave);
                    element.addEventListener('input', triggerAutoSave);
                }
            });
            
            // 監聽工具選擇變更
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', triggerAutoSave);
            });
            
            // 監聽畫筆大小變更
            document.querySelectorAll('.brush-size').forEach(btn => {
                btn.addEventListener('click', triggerAutoSave);
            });
            
            // 監聽預設尺寸按鈕
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', triggerAutoSave);
            });
            
            // 頁面離開前自動儲存
            window.addEventListener('beforeunload', () => {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                    saveSettings();
                }
            });
            
            // 定期自動儲存 (每5分鐘)
            setInterval(() => {
                saveSettings();
            }, 5 * 60 * 1000);
        }

        // 設置匯出事件
        function setupExportEvents() {
            // 預設尺寸按鈕
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const width = parseInt(btn.dataset.width);
                    const height = parseInt(btn.dataset.height);
                    document.getElementById('exportWidth').value = width;
                    document.getElementById('exportHeight').value = height;
                    
                    // 更新按鈕狀態
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // 保持比例
            document.getElementById('keepAspectRatio').addEventListener('change', (e) => {
                if (e.target.checked) {
                    setupAspectRatio();
                }
            });
            
            // 尺寸單位變更
            document.getElementById('exportUnit').addEventListener('change', updateSizeDisplay);
            
            // 寬度變更時保持比例
            document.getElementById('exportWidth').addEventListener('input', (e) => {
                if (document.getElementById('keepAspectRatio').checked) {
                    updateHeightFromWidth(e.target.value);
                }
            });
        }

        // 設置長寬比
        function setupAspectRatio() {
            const currentWidth = canvas.width;
            const currentHeight = canvas.height;
            const ratio = currentWidth / currentHeight;
            
            document.getElementById('exportWidth').value = currentWidth;
            document.getElementById('exportHeight').value = currentHeight;
        }

        // 根據寬度更新高度
        function updateHeightFromWidth(width) {
            const currentWidth = canvas.width;
            const currentHeight = canvas.height;
            const ratio = currentWidth / currentHeight;
            
            const newHeight = Math.round(width / ratio);
            document.getElementById('exportHeight').value = newHeight;
        }

        // 更新尺寸顯示
        function updateSizeDisplay() {
            const unit = document.getElementById('exportUnit').value;
            const dpi = parseInt(document.getElementById('exportDPI').value);
            
            // 這裡可以添加單位轉換邏輯
            console.log(`尺寸單位: ${unit}, DPI: ${dpi}`);
        }

        // 匯出圖像
        function exportImage(format) {
            const width = parseInt(document.getElementById('exportWidth').value);
            const height = parseInt(document.getElementById('exportHeight').value);
            const dpi = parseInt(document.getElementById('exportDPI').value);
            const unit = document.getElementById('exportUnit').value;
            
            if (width < 1 || height < 1) {
                alert('尺寸不能小於 1');
                return;
            }
            
            // 根據單位和DPI計算實際像素尺寸
            const actualWidth = convertToPixels(width, unit, dpi);
            const actualHeight = convertToPixels(height, unit, dpi);
            
            // 創建臨時畫布
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = actualWidth;
            tempCanvas.height = actualHeight;
            
            // 縮放繪製
            tempCtx.drawImage(canvas, 0, 0, actualWidth, actualHeight);
            
            // 匯出
            let dataURL;
            let filename;
            let mimeType;
            
            switch (format) {
                case 'svg':
                    const svgContent = generateSVG();
                    downloadFile(svgContent, 'image.svg', 'image/svg+xml');
                    return;
                case 'png':
                    dataURL = tempCanvas.toDataURL('image/png');
                    filename = 'image.png';
                    mimeType = 'image/png';
                    break;
                case 'jpg':
                    dataURL = tempCanvas.toDataURL('image/jpeg', 0.9);
                    filename = 'image.jpg';
                    mimeType = 'image/jpeg';
                    break;
                case 'webp':
                    dataURL = tempCanvas.toDataURL('image/webp', 0.9);
                    filename = 'image.webp';
                    mimeType = 'image/webp';
                    break;
                case 'pdf':
                    generatePDF(tempCanvas, width, height, unit, dpi);
                    return;
            }
            
            downloadFile(dataURL, filename, mimeType);
        }

        // 單位轉換為像素
        function convertToPixels(value, unit, dpi) {
            switch (unit) {
                case 'px':
                    return value;
                case 'cm':
                    return Math.round(value * dpi / 2.54);
                case 'mm':
                    return Math.round(value * dpi / 25.4);
                case 'in':
                    return Math.round(value * dpi);
                case 'pt':
                    return Math.round(value * dpi / 72);
                default:
                    return value;
            }
        }

        // 生成 PDF
        function generatePDF(canvas, width, height, unit, dpi) {
            // 這裡需要引入 PDF 生成庫，如 jsPDF
            // 暫時提供下載 canvas 的方式
            const dataURL = canvas.toDataURL('image/png');
            downloadFile(dataURL, 'image.pdf', 'application/pdf');
        }

        // 生成 SVG
        function generateSVG() {
            const width = parseInt(document.getElementById('exportWidth').value);
            const height = parseInt(document.getElementById('exportHeight').value);
            const unit = document.getElementById('exportUnit').value;
            
            // 將畫布轉換為 base64
            const dataURL = canvas.toDataURL('image/png');
            
            return `<svg width="${width}${unit}" height="${height}${unit}" xmlns="http://www.w3.org/2000/svg">
                <image href="${dataURL}" width="${width}${unit}" height="${height}${unit}"/>
            </svg>`;
        }

        // 下載檔案
        function downloadFile(content, filename, mimeType = null) {
            const link = document.createElement('a');
            
            if (mimeType) {
                const blob = new Blob([content], { type: mimeType });
                link.href = URL.createObjectURL(blob);
            } else {
                link.href = content;
            }
            
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 更新狀態
        function updateStatus() {
            document.getElementById('canvasSize').textContent = `畫布: ${canvas.width} x ${canvas.height}`;
            document.getElementById('drawingStatus').textContent = `繪製模式: ${isDrawingMode ? '開啟' : '關閉'}`;
        }

        // 更新拖拽區域顯示
        function updateDropZone() {
            const dropZone = document.getElementById('dropZone');
            if (hasImage) {
                dropZone.style.display = 'none';
            } else {
                dropZone.style.display = 'block';
            }
        }

        // 顯示/隱藏載入狀態
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // 初始化應用
        init();
        updateDropZone();
        loadSettings(); // 自動載入設定
    </script>
</body>
</html> 